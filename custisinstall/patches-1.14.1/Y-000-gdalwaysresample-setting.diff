# HG changeset patch
# User Vitaliy Filippov <vitali@st-filippov.office.custis.ru>
# Date 1282043365 -14400
Create branch for patch 000-gdalwaysresample-setting

diff -r 6b77a2bb86d2 -r 51bb13b95034 includes/media/Bitmap.php
--- includes/media/Bitmap.php
+++ includes/media/Bitmap.php
@@ -168,6 +168,7 @@
 			#
 			# First find out what kind of file this is, and select the correct
 			# input routine for this.
+			global $wgGDAlwaysResample;
 
 			$typemap = array(
 				'image/gif'          => array( 'imagecreatefromgif',  'palette',   'imagegif'  ),
@@ -194,11 +195,11 @@
 
 			// Initialise the destination image to transparent instead of
 			// the default solid black, to support PNG and GIF transparency nicely
-			$background = imagecolorallocate( $dst_image, 0, 0, 0 );
+			$background = imagecolorallocatealpha( $dst_image, 0, 0, 0, 0x7f );
 			imagecolortransparent( $dst_image, $background );
 			imagealphablending( $dst_image, false );
 
-			if( $colorStyle == 'palette' ) {
+			if( $colorStyle == 'palette' && !$wgGDAlwaysResample ) {
 				// Don't resample for paletted GIF images.
 				// It may just uglify them, and completely breaks transparency.
 				imagecopyresized( $dst_image, $src_image,
