# HG changeset patch
# User Vitaliy Filippov <vitali@st-filippov.office.custis.ru>
# Date 1277489106 -14400
Bug 65397 - Don`t display session fail when no preview is requested

diff -r 95e6fcaab11e -r 99a83c9f33ad includes/EditPage.php
--- includes/EditPage.php
+++ includes/EditPage.php
@@ -574,7 +574,7 @@
 				# If the form is incomplete, force to preview.
 				wfDebug( "$fname: Form data appears to be incomplete\n" );
 				wfDebug( "POST DATA: " . var_export( $_POST, true ) . "\n" );
-				$this->preview  = true;
+				$this->preview  = $request->getCheck( 'wpPreview' );
 			} else {
 				/* Fallback for live preview */
 				$this->preview = $request->getCheck( 'wpPreview' ) || $request->getCheck( 'wpLivePreview' );
@@ -600,7 +600,7 @@
 					$this->preview = true;
 				}
 			}
-			$this->save = !$this->preview && !$this->diff;
+			$this->save = $request->getCheck('wpSave') && !$this->preview && !$this->diff;
 			if ( !preg_match( '/^\d{14}$/', $this->edittime )) {
 				$this->edittime = null;
 			}
@@ -1066,8 +1066,9 @@
 	 */
 	function initialiseForm() {
 		$this->edittime = $this->mArticle->getTimestamp();
-		$this->textbox1 = $this->getContent( false );
-		if ( $this->textbox1 === false ) return false;
+		$text = $this->getContent( false );
+		if ( $text === false ) return false;
+		if ( $text !== NULL ) $this->textbox1 = $text;
 		wfProxyCheck();
 		return true;
 	}
