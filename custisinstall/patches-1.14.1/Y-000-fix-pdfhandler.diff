# HG changeset patch
# User Vitaliy Filippov <vitali@st-filippov.office.custis.ru>
# Date 1292509033 -10800
Bug 57350 - No wgPdfProcessor escape, add #page= into pdf links

diff -r 2951a613ce57 -r 7789c58e6365 extensions/PdfHandler/PdfHandler_body.php
--- extensions/PdfHandler/PdfHandler_body.php
+++ extensions/PdfHandler/PdfHandler_body.php
@@ -23,6 +23,16 @@
   *
   */
 
+class PdfThumbnailImage extends ThumbnailImage
+{
+	function toHtml( $options = array() )
+	{
+		if ( $options['file-link'] )
+			$options['custom-url-link'] = $this->file->getURL() . '#page=' . $this->page;
+		return parent::toHtml( $options );
+	}
+}
+
 class PdfHandler extends ImageHandler {
 
 	function isEnabled() {
@@ -107,13 +117,13 @@
 			return $this->doTHumbError( $width, $height, 'pdf_page_error' );
 
 		if ( $flags & self::TRANSFORM_LATER )
-			return new ThumbnailImage( $image, $dstUrl, $width,
+			return new PdfThumbnailImage( $image, $dstUrl, $width,
 						   $height, $dstPath, $page );
 
 		if ( !wfMkdirParents( dirname( $dstPath ) ) )
 			return $this->doThumbError( $width, $height, 'thumbnail_dest_directory' );
 
-		$cmd = '(' . wfEscapeShellArg( $wgPdfProcessor );
+		$cmd = '(' . $wgPdfProcessor;
 		$cmd .= " -sDEVICE=jpeg -sOutputFile=- -dFirstPage={$page} -dLastPage={$page}";
 		$cmd .= " -r{$wgPdfHandlerDpi} -dBATCH -dNOPAUSE -q ". wfEscapeShellArg( $srcPath );
 		$cmd .= " | " . wfEscapeShellArg( $wgPdfPostProcessor );
@@ -134,7 +144,7 @@
 				wfHostname(), $retval, trim($err), $cmd ) );
 			return new MediaTransformError( 'thumbnail_error', $width, $height, $err );
 		} else {
-			return new ThumbnailImage( $image, $dstUrl, $width, $height, $dstPath, $page );
+			return new PdfThumbnailImage( $image, $dstUrl, $width, $height, $dstPath, $page );
 		}
 	}
 
