# HG changeset patch
# User Vitaliy Filippov <vitali@st-filippov.office.custis.ru>
# Date 1267036830 -10800

diff -r 2f012c39365a -r 2e1f69ab5448 extensions/Wikilog/Wikilog.php
--- extensions/Wikilog/Wikilog.php
+++ extensions/Wikilog/Wikilog.php
@@ -264,7 +264,7 @@
 
 		if ( ( $wi = self::getWikilogInfo( $title ) ) ) {
 			if ( $title->isTalkPage() ) {
-				if ( $wgWikilogEnableComments && $wi->isItem() ) {
+				if ( $wgWikilogEnableComments ) {
 					$article = new WikilogCommentsPage( $title, $wi );
 				} else {
 					return true;
@@ -456,7 +456,7 @@
 	function getTitle() { return $this->mWikilogTitle; }
 	function getItemName() { return $this->mItemName; }
 	function getItemTitle() { return $this->mItemTitle; }
-	function getItemTalkTitle() { return $this->mItemTitle->getTalkPage(); }
+	function getTalkTitle() { return $this->mItemTitle ? $this->mItemTitle->getTalkPage() : $this->mWikilogTitle->getTalkPage(); }
 
 	function getTrailing() { return $this->mTrailing; }
 }
diff -r 2f012c39365a -r 2e1f69ab5448 extensions/Wikilog/WikilogCommentPager.php
--- extensions/Wikilog/WikilogCommentPager.php
+++ extensions/Wikilog/WikilogCommentPager.php
@@ -72,6 +72,8 @@
 		# Prepare the comment formatter.
 		$this->mFormatter = $formatter ? $formatter :
 			new WikilogCommentFormatter( $this->getSkin() );
+		if (!$query->getItem())
+			$this->mFormatter->setShowItem(true);
 
 		# Parent constructor.
 		parent::__construct();
diff -r 2f012c39365a -r 2e1f69ab5448 extensions/Wikilog/WikilogCommentsPage.php
--- extensions/Wikilog/WikilogCommentsPage.php
+++ extensions/Wikilog/WikilogCommentsPage.php
@@ -95,7 +95,8 @@
 
 		# This flags if we are viewing a single comment (subpage).
 		$this->mTrailing = $wi->getTrailing();
-		$this->mTalkTitle = $wi->getItemTalkTitle();
+		$this->mWikilog = $wi->getTitle();
+		$this->mTalkTitle = $wi->getTalkTitle();
 		if ( $this->mItem && $this->mTrailing ) {
 			$this->mSingleComment =
 				WikilogComment::newFromPageID( $this->mItem, $this->getID() );
@@ -113,15 +114,8 @@
 			return parent::view();
 		}
 
-		if ( !$this->mItem ) {
-			# There is no wikilog article associated with this discussion
-			# page. Act as a normal talk page in this case, leaving
-			# everything to the parent class.
-			return parent::view();
-		}
-
 		# Create our query object.
-		$query = new WikilogCommentQuery( $this->mItem );
+		$query = new WikilogCommentQuery( $this->mItem ? $this->mItem : $this->mWikilog );
 
 		if ( ( $feedFormat = $wgRequest->getVal( 'feed' ) ) ) {
 			# RSS or Atom feed requested. Ignore all other options.
@@ -153,15 +147,18 @@
 			# Note: Sorry for the three-level cascade of wfMsg()'s...
 			$fullPageTitle = wfMsg( 'wikilog-title-item-full',
 				$this->mItem->mName,
-				$this->mItem->mParentTitle->getPrefixedText()
+				$this->mWikilog->getPrefixedText()
 			);
 			$fullPageTitle = wfMsg( 'wikilog-title-comments', $fullPageTitle );
-			$wgOut->setPageTitle( wfMsg( 'wikilog-title-comments', $this->mItem->mName ) );
+			$wgOut->setPageTitle( wfMsg( 'wikilog-title-comments', $this->mItem ? $this->mItem->mName : $this->mWikilog->getPrefixedText() ) );
 			$wgOut->setHTMLTitle( wfMsg( 'pagetitle', $fullPageTitle ) );
 		}
 
 		# Add a backlink to the original article.
-		$link = $this->mSkin->link( $this->mItem->mTitle, $this->mItem->mName );
+		if ($this->mItem)
+			$link = $this->mSkin->link( $this->mItem->mTitle, $this->mItem->mName );
+		else
+			$link = $this->mSkin->link( $this->mWikilog, $this->mWikilog->getPrefixedText() );
 		$wgOut->setSubtitle( wfMsg( 'wikilog-backlink', $link ) );
 
 		# Retrieve comments (or replies) from database and display them.
@@ -296,6 +293,9 @@
 		global $wgUser, $wgTitle, $wgScript, $wgRequest;
 		global $wgWikilogModerateAnonymous;
 
+		if (!$this->mItem && !$parent)
+			return '';
+
 		$comment = $this->mPostedComment;
 		$opts = $this->mFormOptions;
 
@@ -313,7 +313,7 @@
 		}
 
 		$form =
-			Xml::hidden( 'title', $this->getTitle()->getPrefixedText() ) .
+			Xml::hidden( 'title', ( $parent ? $parent->mCommentTitle : $this->getTitle()->getPrefixedText() ) ) .
 			Xml::hidden( 'action', 'wikilog' ) .
 			Xml::hidden( 'wpEditToken', $wgUser->editToken() ) .
 			( $parent ? Xml::hidden( 'wlParent', $parent->mID ) : '' );
