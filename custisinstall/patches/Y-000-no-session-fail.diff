# HG changeset patch
# User Vitaliy Filippov <vitali@st-filippov.office.custis.ru>
# Date 1297179033 -10800
Bug 65397 - Don`t display session fail when no preview is requested

diff -r b11befdd7427 -r cb45c475d8be includes/EditPage.php
--- includes/EditPage.php
+++ includes/EditPage.php
@@ -547,7 +547,7 @@
 				# If the form is incomplete, force to preview.
 				wfDebug( __METHOD__ . ": Form data appears to be incomplete\n" );
 				wfDebug( "POST DATA: " . var_export( $_POST, true ) . "\n" );
-				$this->preview = true;
+				$this->preview = $request->getCheck( 'wpPreview' );
 			} else {
 				/* Fallback for live preview */
 				$this->preview = $request->getCheck( 'wpPreview' ) || $request->getCheck( 'wpLivePreview' );
@@ -573,7 +573,7 @@
 					$this->preview = true;
 				}
 			}
-			$this->save = !$this->preview && !$this->diff;
+			$this->save = $request->getCheck( 'wpSave' ) && !$this->preview && !$this->diff;
 			if ( !preg_match( '/^\d{14}$/', $this->edittime ) ) {
 				$this->edittime = null;
 			}
@@ -1118,7 +1118,6 @@
 	function initialiseForm() {
 		global $wgUser;
 		$this->edittime = $this->mArticle->getTimestamp();
-		$this->textbox1 = $this->getContent( false );
 		// activate checkboxes if user wants them to be always active
 		# Sort out the "watch" checkbox
 		if ( $wgUser->getOption( 'watchdefault' ) ) {
@@ -1133,6 +1132,9 @@
 		}
 		if ( $wgUser->getOption( 'minordefault' ) ) $this->minoredit = true;
 		if ( $this->textbox1 === false ) return false;
+		$text = $this->getContent( false );
+		if ( $text === false ) return false;
+		if ( $text !== NULL ) $this->textbox1 = $text;
 		wfProxyCheck();
 		return true;
 	}
