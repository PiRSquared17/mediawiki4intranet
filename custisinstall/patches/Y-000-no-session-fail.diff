# HG changeset patch
# User Vitaliy Filippov <vitalif@yourcmc.ru>
# Date 1327949154 -14400
Bug 65397 - Don`t display session fail when no preview is requested

diff -r 6b6371ec1416 -r 712ab1e19bcb includes/EditPage.php
--- includes/EditPage.php
+++ includes/EditPage.php
@@ -649,7 +649,7 @@
 				# If the form is incomplete, force to preview.
 				wfDebug( __METHOD__ . ": Form data appears to be incomplete\n" );
 				wfDebug( "POST DATA: " . var_export( $_POST, true ) . "\n" );
-				$this->preview = true;
+				$this->preview = $request->getCheck( 'wpPreview' );
 			} else {
 				/* Fallback for live preview */
 				$this->preview = $request->getCheck( 'wpPreview' ) || $request->getCheck( 'wpLivePreview' );
@@ -675,7 +675,7 @@
 					$this->preview = true;
 				}
 			}
-			$this->save = !$this->preview && !$this->diff;
+			$this->save = $request->getCheck( 'wpSave' ) && !$this->preview && !$this->diff;
 			if ( !preg_match( '/^\d{14}$/', $this->edittime ) ) {
 				$this->edittime = null;
 			}
@@ -1322,7 +1322,6 @@
 	function initialiseForm() {
 		global $wgUser;
 		$this->edittime = $this->mArticle->getTimestamp();
-		$this->textbox1 = $this->getContent( false );
 		// activate checkboxes if user wants them to be always active
 		# Sort out the "watch" checkbox
 		if ( $wgUser->getOption( 'watchdefault' ) ) {
@@ -1341,6 +1340,9 @@
 		if ( $this->textbox1 === false ) {
 			return false;
 		}
+		if ( !trim( $this->textbox1 ) ) {
+			$this->textbox1 = $this->getContent( false );
+		}
 		wfProxyCheck();
 		return true;
 	}
