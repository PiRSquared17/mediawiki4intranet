Index: includes/specials/SpecialImport.php
===================================================================
--- includes/specials/SpecialImport.php	2009-09-21 23:21:18.284973476 +0400
+++ includes/specials/SpecialImport.php	2009-09-21 23:20:31.000000000 +0400
@@ -186,7 +186,9 @@ class ImportReporter {
 		$wgOut->addHtml( "<ul>\n" );
 	}
 
-	function reportPage( $title, $origTitle, $revisionCount, $successCount ) {
+	function reportPage( $title, $origTitle, $revisionCount, $successCount,
+		$lastExistingRevision, $lastLocalRevision, $lastRevision )
+	{
 		global $wgOut, $wgUser, $wgLang, $wgContLang;
 
 		$skin = $wgUser->getSkin();
@@ -196,12 +198,56 @@ class ImportReporter {
 		$localCount = $wgLang->formatNum( $successCount );
 		$contentCount = $wgContLang->formatNum( $successCount );
 
-		if( $successCount > 0 ) {
-			$wgOut->addHtml( "<li>" . $skin->makeKnownLinkObj( $title ) . " " .
-				wfMsgExt( 'import-revision-count', array( 'parsemag', 'escape' ), $localCount ) .
-				"</li>\n"
-			);
+		/* No revisions in import */
+		if (!$lastExistingRevision && $successCount == 0)
+			$msg = wfMsgHtml('import-norevisions');
+
+		/* New page imported */
+		else if (!$lastLocalRevision && $successCount > 0)
+			$msg = wfMsgExt('import-revision-count-newpage', array('parsemag', 'escape'), $localCount);
 
+		else if ($lastExistingRevision)
+		{
+			$newer = $lastLocalRevision->getTimestamp() > $lastExistingRevision->getTimestamp();
+			if ($successCount > 0)
+			{
+				/* Conflict */
+				if ($newer)
+				{
+					$linktext = wfMsgExt( 'import-conflict-difflink',
+						array( 'parsemag', 'escape' ),
+						$lastRevision->getId(),
+						$lastLocalRevision->getId() );
+					$link = $skin->makeKnownLinkObj(
+						$title, $linktext,
+						'diff=' . $lastRevision->getId() .
+						"&oldid=" . $lastLocalRevision->getId() );
+					$msg = wfMsgExt( 'import-conflict',
+						array( 'parsemag' ),
+						$localCount,
+						$link );
+				}
+				/* Page history continued with new revisions */
+				else
+					$msg = wfMsgExt('import-revision-count', array('parsemag', 'escape'), $localCount);
+			}
+			else
+			{
+				/* Local revision is newer */
+				if ($newer)
+					$msg = wfMsgHtml('import-nonewrevisions-localnewer');
+				/* No changes nowhere */
+				else
+					$msg = wfMsgHtml('import-nonewrevisions');
+			}
+		}
+
+		if ($lastRevision || $lastLocalRevision)
+			$msg = $skin->makeKnownLinkObj( $title ) . ': ' . $msg;
+
+		$wgOut->addHtml( "<li>$msg</li>" );
+
+		if( $successCount > 0 ) {
 			$log = new LogPage( 'import' );
 			if( $this->mIsUpload ) {
 				$detail = wfMsgExt( 'import-logentry-upload-detail', array( 'content', 'parsemag' ),
@@ -223,8 +269,6 @@ class ImportReporter {
 			# Update page record
 			$article->updateRevisionOn( $dbw, $nullRevision );
 			wfRunHooks( 'NewRevisionFromEditComplete', array($article, $nullRevision, false) );
-		} else {
-			$wgOut->addHtml( '<li>' . wfMsgHtml( 'import-nonewrevisions' ) . '</li>' );
 		}
 	}
 
@@ -377,7 +422,7 @@ class WikiRevision {
 				wfDebug( __METHOD__ . ": skipping existing revision for [[" .
 					$this->title->getPrefixedText() . "]], timestamp " .
 					$this->timestamp . "\n" );
-				return false;
+				return $prior;
 			}
 		}
 
@@ -421,7 +466,9 @@ class WikiRevision {
 				$revId );
 		}
 
-		return true;
+		# A hack. TOdo it better?
+		$revision->_imported = true;
+		return $revision;
 	}
 
 	function importUpload() {
@@ -531,6 +578,7 @@ class WikiImporter {
 	function __construct( $source ) {
 		$this->setRevisionCallback( array( $this, "importRevision" ) );
 		$this->setUploadCallback( array( $this, "importUpload" ) );
+		$this->setPageCallback( array( $this, "beginPage" ) );
 		$this->mSource = $source;
 	}
 
@@ -730,12 +778,14 @@ class WikiImporter {
 	 * @param $origTitle Title
 	 * @param $revisionCount int
 	 * @param $successCount Int: number of revisions for which callback returned true
+	 * @param $lastExistingRevision Revision
+	 * @param $lastLocalRevision Revision
+	 * @param $lastRevision Revision
 	 * @private
 	 */
-	function pageOutCallback( $title, $origTitle, $revisionCount, $successCount ) {
+	function pageOutCallback() {
 		if( is_callable( $this->mPageOutCallback ) ) {
-			call_user_func( $this->mPageOutCallback, $title, $origTitle,
-				$revisionCount, $successCount );
+			call_user_func_array( $this->mPageOutCallback, func_get_args() );
 		}
 	}
 
@@ -763,6 +813,8 @@ class WikiImporter {
 			$this->workSuccessCount = 0;
 			$this->uploadCount = 0;
 			$this->uploadSuccessCount = 0;
+			$this->lastRevision = NULL;
+			$this->lastExistingRevision = NULL;
 			xml_set_element_handler( $parser, "in_page", "out_page" );
 		} else {
 			return $this->throwXMLerror( "Expected <page>, got <$name>" );
@@ -799,6 +851,28 @@ class WikiImporter {
 		}
 	}
 
+	function beginPage( $title )
+	{
+		$fields = Revision::selectFields();
+		$fields[] = 'page_namespace';
+		$fields[] = 'page_title';
+		$fields[] = 'page_latest';
+		$dbr = wfGetDB( DB_MASTER );
+		$res = $dbr->select(
+			array( 'page', 'revision' ),
+			$fields,
+			array( 'page_id=rev_page',
+			       'page_namespace' => $this->pageTitle->getNamespace(),
+			       'page_title'     => $this->pageTitle->getDBkey(),
+			       'rev_len IS NOT NULL' ),
+			'Revision::fetchRow',
+			array( 'LIMIT' => 1,
+			       'ORDER BY' => 'rev_timestamp DESC' ) );
+		$row = $res->fetchObject();
+		$res->free();
+		if ($row)
+			$this->lastLocalRevision = new Revision( $row );
+	}
 
 	function in_page( $parser, $name, $attribs ) {
 		$this->debug( "in_page $name" );
@@ -849,7 +923,9 @@ class WikiImporter {
 		xml_set_element_handler( $parser, "in_mediawiki", "out_mediawiki" );
 
 		$this->pageOutCallback( $this->pageTitle, $this->origTitle,
-			$this->workRevisionCount, $this->workSuccessCount );
+			$this->workRevisionCount, $this->workSuccessCount,
+			$this->lastExistingRevision, $this->lastLocalRevision,
+			$this->lastRevision );
 
 		$this->workTitle = null;
 		$this->workRevision = null;
@@ -975,9 +1051,12 @@ class WikiImporter {
 		if( $this->workRevision ) {
 			$ok = call_user_func_array( $this->mRevisionCallback,
 				array( $this->workRevision, $this ) );
-			if( $ok ) {
+			if( is_object($ok) && $ok->_imported ) {
+				$this->lastRevision = $ok;
 				$this->workSuccessCount++;
-			}
+			} else if ( is_object($ok) && ( !$this->lastExistingRevision ||
+				$ok->getTimestamp() > $this->lastExistingRevision->getTimestamp() ) )
+				$this->lastExistingRevision = $ok;
 		}
 	}
 
Index: languages/messages/MessagesRu.php
===================================================================
--- languages/messages/MessagesRu.php	2009-09-21 23:23:26.369479764 +0400
+++ languages/messages/MessagesRu.php	2009-09-21 23:22:58.345476900 +0400
@@ -2100,7 +2100,6 @@ Ð’ÑÐµ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸ Ð¼ÐµÐ¶Ð²Ð¸ÐºÐ¸ Ð
 'import-interwiki-namespace' => 'ÐŸÐ¾Ð¼ÐµÑ‰Ð°Ñ‚ÑŒ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹ Ð² Ð¿Ñ€Ð¾ÑÑ‚Ñ€Ð°Ð½ÑÑ‚Ð²Ð¾ Ð¸Ð¼Ñ‘Ð½:',
 'importtext'                 => 'ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, ÑÐºÑÐ¿Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñƒ Ð¸Ð· Ð¸ÑÑ…Ð¾Ð´Ð½Ð¾Ð¹ Ð²Ð¸ÐºÐ¸, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑ [[Special:Export|ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ð¹ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚]]. Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚Ðµ Ñ„Ð°Ð¹Ð» Ð½Ð° Ð´Ð¸ÑÐº, Ð° Ð·Ð°Ñ‚ÐµÐ¼ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚Ðµ ÐµÐ³Ð¾ ÑÑŽÐ´Ð°.',
 'importstart'                => 'Ð˜Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†â€¦',
-'import-revision-count'      => '$1 {{PLURAL:$1|Ð²ÐµÑ€ÑÐ¸Ñ|Ð²ÐµÑ€ÑÐ¸Ð¸|Ð²ÐµÑ€ÑÐ¸Ð¹}}',
 'importnopages'              => 'ÐÐµÑ‚ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ† Ð´Ð»Ñ Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ.',
 'importfailed'               => 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ: $1',
 'importunknownsource'        => 'ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹ Ñ‚Ð¸Ð¿ Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼Ð¾Ð¹ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹',
@@ -2116,9 +2115,15 @@ Ð’ÑÐµ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸ Ð¼ÐµÐ¶Ð²Ð¸ÐºÐ¸ Ð
 'importuploaderrortemp'      => 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ð¸Ð»Ð¸ Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ñ„Ð°Ð¹Ð». Ð’Ñ€ÐµÐ¼ÐµÐ½Ð½Ð°Ñ Ð¿Ð°Ð¿ÐºÐ° Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚.',
 'import-parse-failure'       => 'ÐžÑˆÐ¸Ð±ÐºÐ° Ñ€Ð°Ð·Ð±Ð¾Ñ€Ð° XML Ð¿Ñ€Ð¸ Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ðµ',
 'import-noarticle'           => 'ÐÐµÑ‚ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹ Ð´Ð»Ñ Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ!',
-'import-nonewrevisions'      => 'Ð’ÑÐµ Ñ€ÐµÐ´Ð°ÐºÑ†Ð¸Ð¸ Ð±Ñ‹Ð»Ð¸ Ñ€Ð°Ð½ÐµÐµ Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹.',
 'xml-error-string'           => '$1 Ð² ÑÑ‚Ñ€Ð¾ÐºÐµ $2, Ð¿Ð¾Ð·Ð¸Ñ†Ð¸Ð¸ $3 (Ð±Ð°Ð¹Ñ‚ $4): $5',
 'import-upload'              => 'Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ XML-Ð´Ð°Ð½Ð½Ñ‹Ðµ',
+'import-norevisions'         => 'ÐÐµÑ‚ Ñ€ÐµÐ´Ð°ÐºÑ†Ð¸Ð¹ Ð´Ð»Ñ Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ.',
+'import-nonewrevisions-localnewer' => 'Ð’ÑÐµ Ñ€ÐµÐ´Ð°ÐºÑ†Ð¸Ð¸ Ð±Ñ‹Ð»Ð¸ Ñ€Ð°Ð½ÐµÐµ Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹. Ð¡Ñ‚Ñ€Ð°Ð½Ð¸Ñ†Ð° Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð° Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾.',
+'import-nonewrevisions'      => 'Ð’ÑÐµ Ñ€ÐµÐ´Ð°ÐºÑ†Ð¸Ð¸ Ð±Ñ‹Ð»Ð¸ Ñ€Ð°Ð½ÐµÐµ Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹. Ð›Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ñ… Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹ Ð½ÐµÑ‚.',
+'import-revision-count'      => '$1 {{PLURAL:$1|Ð²ÐµÑ€ÑÐ¸Ñ|Ð²ÐµÑ€ÑÐ¸Ð¸|Ð²ÐµÑ€ÑÐ¸Ð¹}}',
+'import-revision-count-newpage' => '$1 {{PLURAL:$1|Ð²ÐµÑ€ÑÐ¸Ñ|Ð²ÐµÑ€ÑÐ¸Ð¸|Ð²ÐµÑ€ÑÐ¸Ð¹}} (Ð½Ð¾Ð²Ð°Ñ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ð°)',
+'import-conflict'            => '$1 {{PLURAL:$1|Ð²ÐµÑ€ÑÐ¸Ñ|Ð²ÐµÑ€ÑÐ¸Ð¸|Ð²ÐµÑ€ÑÐ¸Ð¹}} (ÐºÐ¾Ð½Ñ„Ð»Ð¸ÐºÑ‚: $2)',
+'import-conflict-difflink'   => '$1 (Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚) Ð¸ $2 (Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð°Ñ)',
 
 # Import log
 'importlogpage'                    => 'Ð–ÑƒÑ€Ð½Ð°Ð» Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ð°',
Index: languages/messages/MessagesEn.php
===================================================================
--- languages/messages/MessagesEn.php	2009-09-21 23:26:08.984981489 +0400
+++ languages/messages/MessagesEn.php	2009-09-21 23:28:57.108979818 +0400
@@ -2550,7 +2550,6 @@ All transwiki import actions are logged 
 'importtext'                 => 'Please export the file from the source wiki using the [[Special:Export|export utility]].
 Save it to your computer and upload it here.',
 'importstart'                => 'Importing pages...',
-'import-revision-count'      => '$1 {{PLURAL:$1|revision|revisions}}',
 'importnopages'              => 'No pages to import.',
 'importfailed'               => 'Import failed: <nowiki>$1</nowiki>',
 'importunknownsource'        => 'Unknown import source type',
@@ -2569,9 +2568,15 @@ The file was only partially uploaded.',
 A temporary folder is missing.',
 'import-parse-failure'       => 'XML import parse failure',
 'import-noarticle'           => 'No page to import!',
-'import-nonewrevisions'      => 'All revisions were previously imported.',
 'xml-error-string'           => '$1 at line $2, col $3 (byte $4): $5',
 'import-upload'              => 'Upload XML data',
+'import-norevisions'         => 'No revisions to import.',
+'import-nonewrevisions-localnewer' => 'All revisions were previously imported. Page changed locally.',
+'import-nonewrevisions'      => 'All revisions were previously imported. No local changes.',
+'import-revision-count'      => '$1 {{PLURAL:$1|revision|revisions}}',
+'import-revision-count-newpage' => '$1 {{PLURAL:$1|revision|revisions}} (new page)',
+'import-conflict'            => '$1 {{PLURAL:$1|revision|revisions}} (conflict: $2)',
+'import-conflict-difflink'   => '$1 (imported) Ð¸ $2 (local)',
 
 # Import log
 'importlogpage'                    => 'Import log',
