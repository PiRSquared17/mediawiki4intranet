# HG changeset patch
# User Vitaliy Filippov <vitalif@yourcmc.ru>
# Date 1328118462 -14400
Bug 64385 - Detailed "invalid title" diagnostics for MediaWiki

diff -r 56d1ccd40a5e -r 0a11b67be7be includes/Title.php
--- includes/Title.php
+++ includes/Title.php
@@ -83,6 +83,7 @@
 	var $mRedirect = null;            // /< Is the article at this title a redirect?
 	var $mNotificationTimestamp = array(); // /< Associative array of user ID -> timestamp/false
 	var $mBacklinkCache = null;       // /< Cache of links to this title
+	var $mBadtitleError = null;       // /< Error which caused the invalid title
 	// @}
 
 
@@ -181,9 +182,10 @@
 	 * the given title's length does not exceed the maximum.
 	 *
 	 * @param $url String the title, as might be taken from a URL
+	 * @param $return_bad boolean True to ignore errors and return invalid title
 	 * @return Title the new object, or NULL on an error
 	 */
-	public static function newFromURL( $url ) {
+	public static function newFromURL( $url, $return_bad = false ) {
 		global $wgLegalTitleChars;
 		$t = new Title();
 
@@ -199,6 +201,8 @@
 // <IntraACL>
 			return $t->checkAccessControl();
 // </IntraACL>
+		} elseif ( $return_bad ) {
+			return $t;
 		} else {
 			return null;
 		}
@@ -2653,6 +2657,7 @@
 	 */
 	private function secureAndSplit() {
 		global $wgContLang, $wgLocalInterwiki;
+		$this->mBadtitleError = NULL;
 
 		# Initialisation
 		$this->mInterwiki = $this->mFragment = '';
@@ -2673,11 +2678,13 @@
 		$dbkey = trim( $dbkey, '_' );
 
 		if ( $dbkey == '' ) {
+			$this->mBadtitleError = array( 'title-invalid-empty' );
 			return false;
 		}
 
 		if ( false !== strpos( $dbkey, UTF8_REPLACEMENT ) ) {
 			# Contained illegal UTF-8 sequences or forbidden Unicode chars.
+			$this->mBadtitleError = array( 'title-invalid-utf8', array( UTF8_REPLACEMENT ) );
 			return false;
 		}
 
@@ -2716,6 +2723,7 @@
 					if ( !$firstPass ) {
 						# Can't make a local interwiki link to an interwiki link.
 						# That's just crazy!
+						$this->mBadtitleError = array( 'title-invalid-double-interwiki' );
 						return false;
 					}
 
@@ -2729,6 +2737,7 @@
 					{
 						if ( $dbkey == '' ) {
 							# Can't have an empty self-link
+							$this->mBadtitleError = array( 'title-invalid-empty' );
 							return false;
 						}
 						$this->mInterwiki = '';
@@ -2765,7 +2774,11 @@
 
 		# Reject illegal characters.
 		$rxTc = self::getTitleInvalidRegex();
-		if ( preg_match( $rxTc, $dbkey ) ) {
+		if( preg_match( $rxTc, $dbkey, $m, PREG_OFFSET_CAPTURE ) ) {
+			$marked = substr( $dbkey, 0, $m[0][1] ) . '--->' . $m[0][0] . '<---' . substr( $dbkey, $m[0][1] + strlen( $m[0][0] ) );
+			$this->mBadtitleError = array( 'title-invalid-characters',
+				array( $m[0][0], mb_strlen( substr( $dbkey, 0, $m[0][1] ) ), mb_strlen( $m[0][0] ), $marked )
+			);
 			return false;
 		}
 
@@ -2781,11 +2794,13 @@
 			   substr( $dbkey, -2 ) == '/.' ||
 			   substr( $dbkey, -3 ) == '/..' ) )
 		{
+			$this->mBadtitleError = array( 'title-invalid-relative' );
 			return false;
 		}
 
 		# Magic tilde sequences? Nu-uh!
-		if ( strpos( $dbkey, '~~~' ) !== false ) {
+		if( ( $p = strpos( $dbkey, '~~~' ) ) !== false ) {
+			$this->mBadtitleError = array( 'title-invalid-magic-tilde', array( $p ) );
 			return false;
 		}
 
@@ -2793,9 +2808,12 @@
 		# underlying database field. We make an exception for special pages, which
 		# don't need to be stored in the database, and may edge over 255 bytes due
 		# to subpage syntax for long titles, e.g. [[Special:Block/Long name]]
-		if ( ( $this->mNamespace != NS_SPECIAL && strlen( $dbkey ) > 255 ) ||
-		  strlen( $dbkey ) > 512 )
+		if ( ( $this->mNamespace != NS_SPECIAL && strlen( $dbkey ) > ( $max = 255 ) ) ||
+		  strlen( $dbkey ) > ( $max = 512 ) )
 		{
+			$chop = substr( $dbkey, 0, $max+1 );
+			$chop = mb_substr( $chop, 0, mb_strlen( $chop ) - 1 );
+			$this->mBadtitleError = array( 'title-invalid-too-long', array( $max, $chop ) );
 			return false;
 		}
 
@@ -2810,6 +2828,7 @@
 		# Can't make a link to a namespace alone... "empty" local links can only be
 		# self-links with a fragment identifier.
 		if ( $dbkey == '' && $this->mInterwiki == '' && $this->mNamespace != NS_MAIN ) {
+			$this->mBadtitleError = array( 'title-invalid-empty' );
 			return false;
 		}
 
@@ -2825,6 +2844,7 @@
 
 		// Any remaining initial :s are illegal.
 		if ( $dbkey !== '' && ':' == $dbkey { 0 } ) {
+			$this->mBadtitleError = array( 'title-invalid-leading-colon' );
 			return false;
 		}
 
diff -r 56d1ccd40a5e -r 0a11b67be7be includes/Wiki.php
--- includes/Wiki.php
+++ includes/Wiki.php
@@ -77,7 +77,11 @@
 		} elseif ( $title == '' && $this->getAction() != 'delete' ) {
 			$ret = Title::newMainPage();
 		} else {
-			$ret = Title::newFromURL( $title );
+			$ret = Title::newFromURL( $title, true );
+			if ( $ret->mBadtitleError ) {
+				// Return invalid titles as-is
+				return $ret;
+			}
 			// Alias NS_MEDIA page URLs to NS_FILE...we only use NS_MEDIA
 			// in wikitext links to tell Parser to make a direct file link
 			if ( !is_null( $ret ) && $ret->getNamespace() == NS_MEDIA ) {
@@ -157,6 +161,13 @@
 			$this->context->setTitle( SpecialPage::getTitleFor( 'Badtitle' ) );
 			// Die now before we mess up $wgArticle and the skin stops working
 			throw new ErrorPageError( 'badtitle', 'badtitletext' );
+		// Show detailed errors for incorrect titles which have $mBadtitleError
+		} elseif ( $title->mBadtitleError ) {
+			$error = $title->mBadtitleError;
+			if ( !$error ) {
+				$error = array( 'badtitle' );
+			}
+			throw new ErrorPageError( $error[0], new Message( $error[0].'text', $error[1] ) );
 		// If the user is not logged in, the Namespace:title of the article must be in
 		// the Read array in order for the user to see it. (We have to check here to
 		// catch special pages etc. We check again in Article::view())
diff -r 56d1ccd40a5e -r 0a11b67be7be languages/messages/MessagesEn.php
--- languages/messages/MessagesEn.php
+++ languages/messages/MessagesEn.php
@@ -946,6 +946,24 @@
 
 A list of valid special pages can be found at [[Special:SpecialPages|{{int:specialpages}}]].',
 
+# Title errors
+'title-invalid-empty'            => 'Empty page title',
+'title-invalid-utf8'             => 'Bad title',
+'title-invalid-double-interwiki' => 'Double interwiki link in page title',
+'title-invalid-characters'       => 'Bad title',
+'title-invalid-relative'         => 'Bad title',
+'title-invalid-magic-tilde'      => 'Bad title',
+'title-invalid-too-long'         => 'Page title is too long',
+'title-invalid-leading-colon'    => 'Bad title',
+'title-invalid-emptytext'            => 'The requested page title is empty or contains only the name of a namespace.',
+'title-invalid-utf8text'             => 'Page title can not contain UTF-8 sequence "$1".',
+'title-invalid-double-interwikitext' => 'The requested page title contains forbidden double interwiki link.',
+'title-invalid-characterstext'       => 'The requested page title contains forbidden characters: "$1" at position $2.',
+'title-invalid-relativetext'         => 'Relative page titles (./, ../) are forbidden, because they will often be unreachable when handled by user\'s browser.',
+'title-invalid-magic-tildetext'      => 'The requested page title contains forbidden magic tilde sequence (~~~).',
+'title-invalid-too-longtext'         => 'The requested page title is too long. It must be no longer than 255 bytes in UTF-8 encoding. Page title short enough would be "$2".',
+'title-invalid-leading-colontext'    => 'The requested page title contains forbidden colons at the beginning.',
+
 # General errors
 'error'                => 'Error',
 'databaseerror'        => 'Database error',
diff -r 56d1ccd40a5e -r 0a11b67be7be languages/messages/MessagesRu.php
--- languages/messages/MessagesRu.php
+++ languages/messages/MessagesRu.php
@@ -604,6 +604,24 @@
 
 Список существующих служебных страниц: [[Special:SpecialPages|{{int:specialpages}}]].',
 
+# Title errors
+'title-invalid-empty'            => 'Пустое имя страницы',
+'title-invalid-utf8'             => 'Недопустимое имя страницы',
+'title-invalid-double-interwiki' => 'Двойная интервики-ссылка',
+'title-invalid-characters'       => 'Недопустимое имя страницы',
+'title-invalid-relative'         => 'Недопустимое имя страницы',
+'title-invalid-magic-tilde'      => 'Недопустимое имя страницы',
+'title-invalid-too-long'         => 'Слишком длинное имя страницы',
+'title-invalid-leading-colon'    => 'Недопустимое имя страницы',
+'title-invalid-emptytext'            => 'Запрашиваемое название страницы пусто либо включает в себя только имя пространства имён без имени страницы.',
+'title-invalid-utf8text'             => 'В названии страницы запрещена UTF-8 последовательность "$1".',
+'title-invalid-double-interwikitext' => 'Запрашиваемое название страницы представляет собой недопустимую двойную интервики-ссылку.',
+'title-invalid-characterstext'       => 'Запрашиваемое название страницы содержит недопустимые символы: "$1" в позиции $2.',
+'title-invalid-relativetext'         => 'Относительные (./, ../) названия страниц запрещены, так как могут быть недоступны при обработке таких последовательностей броузером.',
+'title-invalid-magic-tildetext'      => 'Запрашиваемое название страницы содержит запрещённую магическую последовательность тильд (~~~).',
+'title-invalid-too-longtext'         => 'Запрашиваемое название страницы слишком длинное. Его длина не должна превышать $1 байт в кодировке UTF-8. Корректное по длине название было бы "$2".',
+'title-invalid-leading-colontext'    => 'Запрашиваемое название страницы содержит запрещённые двоеточия в начале.',
+
 # General errors
 'error'                => 'Ошибка',
 'databaseerror'        => 'Ошибка базы данных',
