# HG changeset patch
# User Vitaliy Filippov <vitalif@yourcmc.ru>
# Date 1344604090 -14400
Bug 63447, add hook for MediaWiki::preliminaryChecks()
Bug 71769, add hook for overriding grouping values for enhanced recent changes view
Bug 82496, change url limit from 255 to 4095 for scary transclusions
Bug 93182, Add NormalizeMessageKey to wfMessage()

diff -r b6139b507754 -r 79cacab0e3d8 includes/ChangesList.php
--- includes/ChangesList.php
+++ includes/ChangesList.php
@@ -783,6 +783,7 @@
 			if( $type == RC_LOG ){
 				$secureName = SpecialPage::getTitleFor( 'Log', $logType )->getPrefixedDBkey();
 			}
+			wfRunHooks( 'EnhancedChangesListGroupBy', array( &$rc, &$title, &$secureName ) );
 			if( !isset( $this->rc_cache[$secureName] ) ) {
 				$this->rc_cache[$secureName] = array();
 			}
diff -r b6139b507754 -r 79cacab0e3d8 includes/Message.php
--- includes/Message.php
+++ includes/Message.php
@@ -108,6 +108,7 @@
 	 */
 	public function __construct( $key, $params = array() ) {
 		global $wgLang;
+		wfRunHooks( 'NormalizeMessageKey', array( &$key, &$this->useDatabase, &$langCode, &$transform ) );
 		$this->key = $key;
 		$this->parameters = array_values( $params );
 		$this->language = $wgLang;
diff -r b6139b507754 -r 79cacab0e3d8 includes/Title.php
--- includes/Title.php
+++ includes/Title.php
@@ -1411,12 +1411,20 @@
 	 * @return Array list of errors
 	 */
 	private function checkSpecialsAndNSPermissions( $action, $user, $errors, $doExpensiveQueries, $short ) {
+		/**
+		 * Do not deny all actions except 'createaccount' and 'execute'
+		 * on special pages, let them decide themselves.
+		 * -- vitalif@mail.ru 2011-04-03
+		 * <commented out>:
+		 *
 		# Only 'createaccount' and 'execute' can be performed on
 		# special pages, which don't actually exist in the DB.
 		$specialOKActions = array( 'createaccount', 'execute' );
 		if ( NS_SPECIAL == $this->mNamespace && !in_array( $action, $specialOKActions ) ) {
 			$errors[] = array( 'ns-specialprotected' );
 		}
+		 * </commented out>
+		 */
 
 		# Check $wgNamespaceProtection for restricted namespaces
 		if ( $this->isNamespaceProtected( $user ) ) {
@@ -3946,7 +3954,7 @@
 		}
 
 		list( $name, $lang ) = MessageCache::singleton()->figureMessage( $wgContLang->lcfirst( $this->getText() ) );
-		$message = wfMessage( $name )->inLanguage( $lang )->useDatabase( false );
+		$message = wfMessage( $name )->inLanguage( $lang );
 
 		if ( $message->exists() ) {
 			return $message->plain();
diff -r b6139b507754 -r 79cacab0e3d8 includes/parser/Parser.php
--- includes/parser/Parser.php
+++ includes/parser/Parser.php
@@ -3453,7 +3453,7 @@
 
 		$url = $title->getFullUrl( "action=$action" );
 
-		if ( strlen( $url ) > 255 ) {
+		if ( strlen( $url ) > 4095 ) {
 			return wfMsgForContent( 'scarytranscludetoolong' );
 		}
 		return $this->fetchScaryTemplateMaybeFromCache( $url );
diff -r b6139b507754 -r 79cacab0e3d8 includes/specials/SpecialMovepage.php
--- includes/specials/SpecialMovepage.php
+++ includes/specials/SpecialMovepage.php
@@ -231,7 +231,7 @@
 					Xml::label( wfMsg( 'newtitle' ), 'wpNewTitle' ) .
 				"</td>
 				<td class='mw-input'>" .
-					Xml::input( 'wpNewTitle', 40, $wgContLang->recodeForEdit( $newTitle->getPrefixedText() ), array( 'type' => 'text', 'id' => 'wpNewTitle' ) ) .
+					Xml::input( 'wpNewTitle', 80, $wgContLang->recodeForEdit( $newTitle->getPrefixedText() ), array( 'type' => 'text', 'id' => 'wpNewTitle' ) ) .
 					Html::hidden( 'wpOldTitle', $this->oldTitle->getPrefixedText() ) .
 				"</td>
 			</tr>
