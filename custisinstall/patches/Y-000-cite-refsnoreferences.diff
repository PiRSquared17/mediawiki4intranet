# HG changeset patch
# User Vitaliy Filippov <vitali@st-filippov.office.custis.ru>
# Date 1301327463 -14400
Bug 77150 - Check refsNoReferences only when clearState == true

diff -r 9cc4b1960d33 -r b01d663c050e extensions/Cite/Cite_body.php
--- extensions/Cite/Cite_body.php
+++ extensions/Cite/Cite_body.php
@@ -878,8 +878,8 @@
 	 * Called at the end of page processing to append an error if refs were 
 	 * used without a references tag.
 	 */
-	function checkRefsNoReferences(&$parser, &$text){
-		if ( $parser->getOptions()->getIsSectionPreview() ) return true;
+	function checkRefsNoReferences(&$parser, &$text, $clearState){
+		if ( $parser->getOptions()->getIsSectionPreview() || !$clearState ) return true;
 
 		foreach ( $this->mRefs as $group => $refs ) {
 			if ( count( $refs ) == 0 ) continue;
diff -r 9cc4b1960d33 -r b01d663c050e includes/parser/Parser.php
--- includes/parser/Parser.php
+++ includes/parser/Parser.php
@@ -394,7 +394,7 @@
 
 		$text = $this->mStripState->unstripNoWiki( $text );
 
-		wfRunHooks( 'ParserBeforeTidy', array( &$this, &$text ) );
+		wfRunHooks( 'ParserBeforeTidy', array( &$this, &$text, $clearState ) );
 
 //!JF Move to its own function
 
@@ -452,7 +452,7 @@
 			$this->limitationWarn( 'expensive-parserfunction', $this->mExpensiveFunctionCount, $wgExpensiveParserFunctionLimit );
 		}
 
-		wfRunHooks( 'ParserAfterTidy', array( &$this, &$text ) );
+		wfRunHooks( 'ParserAfterTidy', array( &$this, &$text, $clearState ) );
 
 		# Information on include size limits, for the benefit of users who try to skirt them
 		if ( $this->mOptions->getEnableLimitReport() ) {
