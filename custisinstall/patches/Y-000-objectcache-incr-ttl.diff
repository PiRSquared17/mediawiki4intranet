# HG changeset patch
# User Vitaliy Filippov <vitalif@yourcmc.ru>
# Date 1337942363 -14400
Bug 98050 - Preserve key TTL in XXBagOStuff::incr()

diff -r b6139b507754 -r d1090d6c5b54 includes/objectcache/APCBagOStuff.php
--- includes/objectcache/APCBagOStuff.php
+++ includes/objectcache/APCBagOStuff.php
@@ -9,7 +9,7 @@
 	public function get( $key ) {
 		$val = apc_fetch( $key );
 
-		if ( is_string( $val ) ) {
+		if ( !is_numeric( $val ) && is_string( $val ) ) {
 			$val = unserialize( $val );
 		}
 
@@ -17,7 +17,11 @@
 	}
 
 	public function set( $key, $value, $exptime = 0 ) {
-		apc_store( $key, serialize( $value ), $exptime );
+		if ( !is_numeric( $value ) ) {
+			$value = serialize( $value );
+		}
+
+		apc_store( $key, $value, $exptime );
 
 		return true;
 	}
@@ -28,6 +32,10 @@
 		return true;
 	}
 
+	public function incr( $key, $value = 1 ) {
+		return apc_inc( $key, $value, $success );
+	}
+
 	public function keys() {
 		$info = apc_cache_info( 'user' );
 		$list = $info['cache_list'];
diff -r b6139b507754 -r d1090d6c5b54 includes/objectcache/BagOStuff.php
--- includes/objectcache/BagOStuff.php
+++ includes/objectcache/BagOStuff.php
@@ -118,6 +118,7 @@
 	}
 
 	/**
+	 * Increase stored value of $key by $value while preserving its TTL (!)
 	 * @param $key String: Key to increase
 	 * @param $value Integer: Value to add to $key (Default 1)
 	 * @return null if lock is not possible else $key value increased by $value
diff -r b6139b507754 -r d1090d6c5b54 includes/objectcache/DBABagOStuff.php
--- includes/objectcache/DBABagOStuff.php
+++ includes/objectcache/DBABagOStuff.php
@@ -177,6 +177,33 @@
 		return $ret;
 	}
 
+	function incr( $key, $step = 1 ) {
+		wfProfileIn( __METHOD__ );
+
+		$handle = $this->getWriter();
+
+		if ( !$handle ) {
+			wfProfileOut( __METHOD__ );
+			return false;
+		}
+
+		list( $value, $expiry ) = $this->decode( dba_fetch( $key, $handle ) );
+		if ( $expiry < time() ) {
+			$value = 0;
+			$expiry = 0;
+		}
+		$value += $step;
+		$blob = $this->encode( $value, $expiry );
+
+		$ret = dba_replace( $key, $blob, $handle );
+
+		dba_close( $handle );
+
+		wfProfileOut( __METHOD__ );
+
+		return $value;
+	}
+
 	function keys() {
 		$reader = $this->getReader();
 		$k1 = dba_firstkey( $reader );
diff -r b6139b507754 -r d1090d6c5b54 includes/objectcache/XCacheBagOStuff.php
--- includes/objectcache/XCacheBagOStuff.php
+++ includes/objectcache/XCacheBagOStuff.php
@@ -16,7 +16,7 @@
 	public function get( $key ) {
 		$val = xcache_get( $key );
 
-		if ( is_string( $val ) ) {
+		if ( !is_numeric( $val ) && is_string( $val ) ) {
 			$val = unserialize( $val );
 		}
 
@@ -32,7 +32,11 @@
 	 * @return bool
 	 */
 	public function set( $key, $value, $expire = 0 ) {
-		xcache_set( $key, serialize( $value ), $expire );
+		if ( !is_numeric( $value ) ) {
+			$value = serialize( $value );
+		}
+
+		xcache_set( $key, $value, $expire );
 		return true;
 	}
 
@@ -47,5 +51,13 @@
 		xcache_unset( $key );
 		return true;
 	}
+
+	/**
+	 * Increase stored value of $key by $value while preserving its TTL (!)
+	 */
+	public function incr( $key, $value = 1 ) {
+		return xcache_inc( $key, $value );
+	}
+
 }
 
