# HG changeset patch
# User Vitaliy Filippov <vitalif@yourcmc.ru>
# Date 1313685857 -10800
Bug 54239 - Ссылки на разделы с нумерацией

diff -r 45da8fc662c9 -r c7084fc649d0 includes/parser/Parser.php
--- includes/parser/Parser.php
+++ includes/parser/Parser.php
@@ -1,4 +1,3 @@
-<?php
 /**
  * @defgroup Parser Parser
  *
@@ -3724,6 +3723,10 @@
 
 			# Don't number the heading if it is the only one (looks silly)
 			if( $doNumberHeadings && count( $matches[3] ) > 1) {
+				# Bug 54239 - Number [[#Section|Section]] links
+				if (!$headNumberReplacer)
+					$headNumberReplacer = new ReplacementArray();
+				$headNumberReplacer->setPair('>'.$headlineHint.'</a>', '>'.$numbering.' '.$headlineHint.'</a>');
 				# the two are different if the line contains a link
 				$headline = $numbering . ' ' . $headline;
 			}
@@ -3803,6 +3806,10 @@
 			$this->mOutput->setSections( $tocraw );
 		}
 
+		# Bug 54239 - Number [[#Section|Section]] links
+		if ($headNumberReplacer)
+			$text = $headNumberReplacer->replace($text);
+
 		# split up and insert constructed headlines
 
 		$blocks = preg_split( '/<H[1-6].*?' . '>.*?<\/H[1-6]>/i', $text );
