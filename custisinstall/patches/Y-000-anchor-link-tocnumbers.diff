# HG changeset patch
# User Vitaliy Filippov <vitali@st-filippov.office.custis.ru>
# Date 1297452295 -10800
Bug 54239 - Ссылки на разделы с нумерацией

diff -r b11befdd7427 -r 4a2257344a47 includes/parser/Parser.php
--- includes/parser/Parser.php
+++ includes/parser/Parser.php
@@ -3724,6 +3724,10 @@
 
 			# Don't number the heading if it is the only one (looks silly)
 			if( $doNumberHeadings && count( $matches[3] ) > 1) {
+				# Bug 54239 - Ссылки на разделы с нумерацией
+				if (!$headNumberReplacer)
+					$headNumberReplacer = new ReplacementArray();
+				$headNumberReplacer->setPair('>'.trim($headline).'</a>', '>'.$numbering.' '.trim($headline).'</a>');
 				# the two are different if the line contains a link
 				$headline = $numbering . ' ' . $headline;
 			}
@@ -3803,6 +3807,10 @@
 			$this->mOutput->setSections( $tocraw );
 		}
 
+		# Bug 54239 - Ссылки на разделы с нумерацией
+		if ($headNumberReplacer)
+			$text = $headNumberReplacer->replace($text);
+
 		# split up and insert constructed headlines
 
 		$blocks = preg_split( '/<H[1-6].*?' . '>.*?<\/H[1-6]>/i', $text );
