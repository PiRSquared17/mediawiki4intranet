# HG changeset patch
# User Vitaliy Filippov <vitalif@yourcmc.ru>
# Date 1327949591 -14400
Bug 54239 - Ссылки на разделы с нумерацией

diff -r 6b6371ec1416 -r f7cfc9e9e800 includes/parser/Parser.php
--- includes/parser/Parser.php
+++ includes/parser/Parser.php
@@ -3974,6 +3974,11 @@
 
 			# Don't number the heading if it is the only one (looks silly)
 			if ( count( $matches[3] ) > 1 && $this->mOptions->getNumberHeadings() ) {
+				# CustIS Bug 54239 - Number [[#Section|Section]] links
+				if ( empty( $headNumberReplacer ) ) {
+					$headNumberReplacer = new ReplacementArray();
+				}
+				$headNumberReplacer->setPair('>'.$headlineHint.'</a>', '>'.$numbering.' '.$headlineHint.'</a>');
 				# the two are different if the line contains a link
 				$headline = $numbering . ' ' . $headline;
 			}
@@ -4069,6 +4074,10 @@
 			$this->mOutput->setSections( $tocraw );
 		}
 
+		# Bug 54239 - Number [[#Section|Section]] links
+		if ( !empty( $headNumberReplacer ) )
+			$text = $headNumberReplacer->replace($text);
+
 		# split up and insert constructed headlines
 
 		$blocks = preg_split( '/<H[1-6].*?' . '>.*?<\/H[1-6]>/i', $text );
