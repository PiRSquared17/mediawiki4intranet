# HG changeset patch
# User Vitaliy Filippov <vitali@st-filippov.office.custis.ru>
# Date 1291048423 -10800
Depends on: Y-000-debug-wikilog.diff

Patch includes several simple fixes required for MediaWiki to run under
more restrictive PHP 5.3.x.

Signed-off-by: Vitaliy Filippov <vitali@st-filippov.office.custis.ru>

diff -r 2951a613ce57 -r cbb89bc3fcba extensions/Interwiki/Interwiki_body.php
--- extensions/Interwiki/Interwiki_body.php
+++ extensions/Interwiki/Interwiki_body.php
@@ -179,7 +179,7 @@
 		global $wgRequest, $wgOut;
 		$prefix = $wgRequest->getVal( 'wpInterwikiPrefix' );
 		$do = $wgRequest->getVal( 'wpInterwikiAction' );
-		if( preg_match( '/[\s:&=]/', $prefix ) ) {
+		if( $do != 'delete' && preg_match( '/[\s:&=]/', $prefix ) ) {
 			$this->error( 'interwiki-badprefix', htmlspecialchars( $prefix ) );
 			$this->showForm( $do );
 			return;
@@ -201,8 +201,9 @@
 				$log->addEntry( 'iw_delete', $selfTitle, $reason, array( $prefix ) );
 			}
 			break;
+		case 'add':
+			$prefix = mb_strtolower( $prefix );
 		case 'edit':
-		case 'add':
 			$theurl = $wgRequest->getVal( 'wpInterwikiURL' );
 			$local = $wgRequest->getCheck( 'wpInterwikiLocal' ) ? 1 : 0;
 			$trans = $wgRequest->getCheck( 'wpInterwikiTrans' ) ? 1 : 0;
diff -r 2951a613ce57 -r cbb89bc3fcba includes/FileDeleteForm.php
--- includes/FileDeleteForm.php
+++ includes/FileDeleteForm.php
@@ -108,7 +108,7 @@
 				$id = $title->getArticleID( GAID_FOR_UPDATE );
 				// Need to delete the associated article
 				$article = new Article( $title );
-				if( wfRunHooks('ArticleDelete', array(&$article, &$wgUser, &$reason)) ) {
+				if( wfRunHooks('ArticleDelete', array(&$article, &$wgUser, &$reason, &$error)) ) {
 					if( $article->doDeleteArticle( $reason, $suppress, $id ) ) {
 						global $wgRequest;
 						if( $wgRequest->getCheck( 'wpWatch' ) ) {
diff -r 2951a613ce57 -r cbb89bc3fcba includes/Title.php
--- includes/Title.php
+++ includes/Title.php
@@ -2445,7 +2445,7 @@
 				if( $nt->getText() != wfStripIllegalFilenameChars( $nt->getText() ) ) {
 					$errors[] = array('imageinvalidfilename');
 				}
-				if( !File::checkExtensionCompatibility( $file, $nt->getDBKey() ) ) {
+				if( File::checkExtensionCompatibility( $file, $nt->getDBKey() ) === false ) {
 					$errors[] = array('imagetypemismatch');
 				}
 			}
diff -r 2951a613ce57 -r cbb89bc3fcba languages/Language.php
--- languages/Language.php
+++ languages/Language.php
@@ -1755,7 +1755,7 @@
 	}
 
 	# Fill a MagicWord object with data from here
-	function getMagic( &$mw ) {
+	function getMagic( $mw ) {
 		if ( !$this->mMagicHookDone ) {
 			$this->mMagicHookDone = true;
 			wfRunHooks( 'LanguageGetMagic', array( &$this->mMagicExtensions, $this->getCode() ) );
