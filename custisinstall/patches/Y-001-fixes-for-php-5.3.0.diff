# HG changeset patch
# User Vitaliy Filippov <vitali@st-filippov.office.custis.ru>
# Date 1299317938 -10800
Depends on: Y-000-debug-wikilog.diff

Patch includes several simple fixes required for MediaWiki to run under
more restrictive PHP 5.3.x.

Signed-off-by: Vitaliy Filippov <vitali@st-filippov.office.custis.ru>

diff -r 9cc4b1960d33 -r 87c95ed1e406 extensions/Interwiki/Interwiki_body.php
--- extensions/Interwiki/Interwiki_body.php
+++ extensions/Interwiki/Interwiki_body.php
@@ -176,7 +176,7 @@
 		global $wgRequest, $wgOut;
 		$prefix = $wgRequest->getVal( 'wpInterwikiPrefix' );
 		$do = $wgRequest->getVal( 'wpInterwikiAction' );
-		if( preg_match( '/[\s:&=]/', $prefix ) ) {
+		if( $do != 'delete' && preg_match( '/[\s:&=]/', $prefix ) ) {
 			$this->error( 'interwiki-badprefix', htmlspecialchars( $prefix ) );
 			$this->showForm( $do );
 			return;
@@ -198,8 +198,9 @@
 				$log->addEntry( 'iw_delete', $selfTitle, $reason, array( $prefix ) );
 			}
 			break;
+		case 'add':
+			$prefix = mb_strtolower( $prefix );
 		case 'edit':
-		case 'add':
 			$theurl = $wgRequest->getVal( 'wpInterwikiURL' );
 			$local = $wgRequest->getCheck( 'wpInterwikiLocal' ) ? 1 : 0;
 			$trans = $wgRequest->getCheck( 'wpInterwikiTrans' ) ? 1 : 0;
diff -r 9cc4b1960d33 -r 87c95ed1e406 extensions/SyntaxHighlight_GeSHi/SyntaxHighlight_GeSHi.class.php
--- extensions/SyntaxHighlight_GeSHi/SyntaxHighlight_GeSHi.class.php
+++ extensions/SyntaxHighlight_GeSHi/SyntaxHighlight_GeSHi.class.php
@@ -306,7 +306,7 @@
 		if( !self::$initialised ) {
 			wfLoadExtensionMessages( 'SyntaxHighlight_GeSHi' );
 			if( !class_exists( 'GeSHi' ) )
-				require( 'geshi/geshi.php' );
+				require_once( 'geshi/geshi.php' );
 			self::$initialised = true;
 		}
 		return true;
@@ -317,7 +317,8 @@
 	 */
 	public static function hSpecialVersion_GeSHi( &$sp, &$extensionTypes ) {
 		global $wgExtensionCredits;
-		require_once( 'geshi/geshi.php' );
+		if ( !class_exists( 'GeSHi' ) )
+			require_once( 'geshi/geshi.php' );
 		$wgExtensionCredits['parserhook']['SyntaxHighlight_GeSHi']['version'] = GESHI_VERSION;
 		return true;
 	}
diff -r 9cc4b1960d33 -r 87c95ed1e406 extensions/WikiCategoryTagCloud/WikiCategoryTagCloud.php
--- extensions/WikiCategoryTagCloud/WikiCategoryTagCloud.php
+++ extensions/WikiCategoryTagCloud/WikiCategoryTagCloud.php
@@ -45,7 +45,7 @@
 }
 
 function invalidateCache() {
-	$titles[0] = explode( "\n", wfMsg( 'tagcloudpages' ) );
+	$titles = explode( "\n", wfMsg( 'tagcloudpages' ) );
 
 	for ( $i = 0; $i < count( $titles ); $i++ ) {
 		$t = Title::newFromText( $titles[$i] );
