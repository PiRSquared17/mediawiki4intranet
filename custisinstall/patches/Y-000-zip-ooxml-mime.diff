# HG changeset patch
# User Vitaliy Filippov <vitalif@yourcmc.ru>
# Date 1337954358 -14400
Bug 79501 - Determine OOXML types correctly, allow external mime magic for invalid zip files
Bug 43343 - Add application/vnd.ms-office and application/vnd.visio MIME types for Visio
Bug 100212 - Skip Java applet check for office document types

diff -r b6139b507754 -r 360747a687b4 includes/mime.types
--- includes/mime.types
+++ includes/mime.types
@@ -16,6 +16,8 @@
 application/vnd.mif mif
 application/vnd.ms-excel xls xlt xla
 application/vnd.ms-powerpoint ppt pot pps ppa
+application/vnd.ms-office vsd
+application/vnd.visio vsd
 application/vnd.wap.wbxml wbxml
 application/vnd.wap.wmlc wmlc
 application/vnd.wap.wmlscriptc wmlsc
diff -r b6139b507754 -r 360747a687b4 includes/upload/UploadBase.php
--- includes/upload/UploadBase.php
+++ includes/upload/UploadBase.php
@@ -380,8 +380,10 @@
 		}
 
 		# Check for Java applets, which if uploaded can bypass cross-site
-		# restrictions.
-		if ( !$wgAllowJavaUploads ) {
+		# restrictions. But skip the ZIP check for office documents which
+		# can contain both OOXML and binary data at once which will cause
+		# errors.
+		if ( !$wgAllowJavaUploads && !preg_match( '#^application/(msword|vnd\.)#s', $mime ) ) {
 			$this->mJavaDetected = false;
 			$zipStatus = ZipDirectoryReader::read( $this->mTempPath,
 				array( $this, 'zipEntryCallback' ) );
