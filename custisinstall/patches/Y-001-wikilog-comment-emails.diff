# HG changeset patch
# User Vitaliy Filippov <vitali@st-filippov.office.custis.ru>
# Date 1271866704 -14400
Depends on: Y-000-html-emails.diff

Bug 62693 - Wikilog comment email notification support

diff -r 6fc96b521854 -r 4adb1e82d3e5 extensions/Wikilog/Wikilog.i18n.php
--- extensions/Wikilog/Wikilog.i18n.php
+++ extensions/Wikilog/Wikilog.i18n.php
@@ -115,6 +115,29 @@
 	'wikilog-newtalk-text' => '<!-- blank page created by Wikilog -->',
 	'wikilog-newtalk-summary' => 'created automatically by Wikilog',
 
+	/* These messages are parsed inside the context of item page, so {{SUBPAGENAME}} refers to the item,
+	   and <a href=""> is a crunch to output links instead of just bold text. */
+	'wikilog-comment-email-subject' => '$2 - A new comment to {{SUBPAGENAME}}',
+	'wikilog-comment-email-body' =>
+'A new reply {{#if:$6|was added by [[{{ns:User}}:$2|$2]] to the following [[{{ns:User}}:$6|$6]]\'s
+comment to the post <html><a href="$3"></html>{{SUBPAGENAME}}<html></a></html>:
+
+<div style="border-style: solid; border-color: black; border-width: 0 0 0 3px; padding-left: 8px;">
+{{:$5}}
+</div>
+
+The reply was:|to <html><a href="$3"></html>{{SUBPAGENAME}}<html></a></html> was added by [[{{ns:User}}:$2|$2]]:}}
+
+<div style="border-style: solid; border-color: black; border-width: 0 0 0 3px; padding-left: 8px;">
+{{:$1}}
+</div>
+
+Available actions:
+
+* [[{{TALKPAGENAME}}#$4|Read the whole discussion]] of the post {{SUBPAGENAME}}.
+* <html><a href="$3"></html>Read the post {{SUBPAGENAME}}<html></a></html>.
+* [[$1|Read discussion thread]] beginning with this specific comment.',
+
 	# Atom and RSS feeds
 	'wikilog-feed-title' => '{{SITENAME}} - $1 [$2]', # $1 = title, $2 = content language
 	'wikilog-feed-description' => 'Read the most recent posts in this feed.',
@@ -4939,6 +4962,30 @@
 	'wikilog-comment-feed-title1' => 'Комментарии от $2 (#$1)',
 	'wikilog-comment-feed-title2' => 'Комментарий от $2 к $3 (#$1)',
 	'wikilog-comment-feed-description' => 'Читать последние комментарии на этом канале.',
+
+	/* These messages are parsed inside the context of item page, so {{SUBPAGENAME}} refers to the item,
+	   and <a href=""> is a crunch to output links instead of just bold text. */
+	'wikilog-comment-email-subject' => '$2 - Новый комментарий к {{SUBPAGENAME}}',
+	'wikilog-comment-email-body' =>
+'Пользователь [[{{ns:User}}:$2|$2]] ответил на {{#if:$6|комментарий, оставленный
+[[{{ns:User}}:$6|$6]] к записи <html><a href="$3"></html>{{SUBPAGENAME}}<html></a></html>:
+
+<div style="border-style: solid; border-color: black; border-width: 0 0 0 3px; padding-left: 8px;">
+{{:$5}}
+</div>
+
+Ответ был таким:|запись <html><a href="$3"></html>{{SUBPAGENAME}}<html></a></html>:}}
+
+<div style="border-style: solid; border-color: black; border-width: 0 0 0 3px; padding-left: 8px;">
+{{:$1}}
+</div>
+
+Доступные действия:
+
+* [[{{TALKPAGENAME}}#$4|Просмотреть полное обсуждение]] записи {{SUBPAGENAME}}.
+* <html><a href="$3"></html>Прочитать запись {{SUBPAGENAME}}<html></a></html>.
+* [[$1|Просмотреть ветвь обсуждения]], содержащую данный комментарий, с начала.',
+
 	'wikilog-title-comments' => 'Комментарии — $1',
 	'wikilog-error-msg' => 'Викилог: $1',
 	'wikilog-error-title' => 'Ошибка викилога',
diff -r 6fc96b521854 -r 4adb1e82d3e5 extensions/Wikilog/WikilogComment.php
--- extensions/Wikilog/WikilogComment.php
+++ extensions/Wikilog/WikilogComment.php
@@ -60,6 +60,7 @@
 	 */
 	public  $mID			= null;		///< Comment ID.
 	public  $mParent		= null;		///< Parent comment ID.
+	public  $mParentObj		= null;		///< Parent comment object.
 	public  $mThread		= null;		///< Comment thread.
 	public  $mUserID		= null;		///< Comment author user id.
 	public  $mUserText		= null;		///< Comment author user name.
@@ -173,6 +174,7 @@
 		$delayed = array();
 
 		# Main update.
+		$sendtext = false;
 		if ( $this->mID ) {
 			$dbw->update( 'wikilog_comments', $data,
 				array( 'wlc_id' => $this->mID ), __METHOD__ );
@@ -183,8 +185,18 @@
 			$this->mID = $dbw->insertId();
 
 			# Now that we have an ID, we can generate the thread.
-			$this->mThread = self::getThreadHistory( $this->mID, $this->mParent );
+			$this->mThread = array();
+			if( $this->mParent )
+			{
+				if( !$this->mParentObj )
+					$this->mParentObj = WikilogComment::newFromID( $this->mItem, $this->mParent );
+				if( !$this->mParentObj || !$this->mParentObj->mThread )
+					throw new MWException( 'Invalid parent history.' );
+				$this->mThread = $this->mParentObj->mThread;
+			}
+			$this->mThread[] = self::padID( $this->mID );
 			$delayed['wlc_thread'] = implode( '/', $this->mThread );
+			$emailnotify = true;
 		}
 
 		# Save article with comment text.
@@ -215,6 +227,63 @@
 		$this->mItem->mTitle->invalidateCache();
 		$this->mItem->mTitle->getTalkPage()->invalidateCache();
 		$this->mItem->mParentTitle->invalidateCache();
+
+		# Notify item and parent comment authors about new comment
+		if ( $emailnotify )
+			$this->sendCommentEmails();
+	}
+
+	/**
+	 * Notify about new comment by email
+	 */
+	public function sendCommentEmails()
+	{
+		global $wgParser, $wgPasswordSender;
+		/* Message arguments:
+		 * $1 = full page name of comment page
+		 * $2 = name of a user who posted the new comment
+		 * $3 = full URL to Wikilog item
+		 * $4 = Wikilog item talk page anchor for the new comment
+		 * $5 (optional) = full page name of parent comment page
+		 * $6 (optional) = name of a user who posted the parent comment
+		 */
+		$args = array(
+			$this->mCommentTitle->getPrefixedText(),
+			$this->mUserText,
+			$this->mItem->mTitle->getFullURL(),
+			'c' . $this->mID,
+			'',
+			'',
+		);
+		$to_ids = array_flip( $this->mItem->mAuthors );
+		if ( $this->mParentObj )
+		{
+			$to_ids[$this->mParentObj->mUserID] = true;
+			$args[5] = $this->mParentObj->mCommentTitle->getPrefixedText();
+			$args[6] = $this->mParentObj->mUserText;
+		}
+		$saveExpUrls = WikilogParser::expandLocalUrls();
+		$popt = new ParserOptions( User::newFromId( $this->mUserID ) );
+		$subject = $wgParser->parse( wfMsgNoTrans( 'wikilog-comment-email-subject', $args ),
+			$this->mItem->mTitle, $popt, false, false );
+		$subject = strip_tags( $subject->getText() );
+		$body = $wgParser->parse( wfMsgNoTrans( 'wikilog-comment-email-body', $args ),
+			$this->mItem->mTitle, $popt, true, false );
+		$body = $body->getText();
+		WikilogParser::expandLocalUrls( $saveExpUrls );
+		$to = array();
+		foreach( $to_ids as $id => $true )
+		{
+			$email = new MailAddress( User::newFromId( $id )->getEmail() );
+			if( $email )
+				$to[] = $email;
+		}
+		$from = User::newFromId( $this->mUserID );
+		if ( $from && $from->getEmail() )
+			$from = new MailAddress( $from->getEmail(), $from->getRealName() );
+		else
+			$from = new MailAddress( $wgPasswordSender, 'WikiAdmin' );
+		UserMailer::send( $to, $from, $subject, $body );
 	}
 
 	/**
