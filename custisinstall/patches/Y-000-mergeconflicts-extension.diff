# HG changeset patch
# User Vitaliy Filippov <vitalif@yourcmc.ru>
# Date 1327949218 -14400
Bug 80143 - Extension patch for changing merge conflict display style

diff -r 6b6371ec1416 -r 1cd1a4762366 includes/DefaultSettings.php
--- includes/DefaultSettings.php
+++ includes/DefaultSettings.php
@@ -5556,6 +5556,9 @@
 $wgDBtestuser = ''; //db user that has permission to create and drop the test databases only
 $wgDBtestpassword = '';
 
+/** Defines that MergeConflicts extension patch was applied to this MW installation */
+define ( 'MW_PATCH_MERGE_CONFLICTS', 1 );
+
 /**
  * For really cool vim folding this needs to be at the end:
  * vim: foldmarker=@{,@} foldmethod=marker
diff -r 6b6371ec1416 -r 1cd1a4762366 includes/EditPage.php
--- includes/EditPage.php
+++ includes/EditPage.php
@@ -1096,12 +1096,15 @@
 				$text = $this->textbox1; // do not try to merge here!
 			} elseif ( $this->isConflict ) {
 				# Attempt merge
-				if ( $this->mergeChangesInto( $text ) ) {
+				if ( $result = $this->mergeChangesInto( $text ) ) {
 					// Successful merge! Maybe we should tell the user the good news?
 					$this->isConflict = false;
 					wfDebug( __METHOD__ . ": Suppressing edit conflict, successful merge.\n" );
 				} else {
 					$this->section = '';
+					// was merging available?
+					$this->mMergeAvailable = $result !== NULL;
+					$this->textbox2 = $this->textbox1;
 					$this->textbox1 = $text;
 					wfDebug( __METHOD__ . ": Keeping edit conflict, failed merge.\n" );
 				}
@@ -1495,7 +1498,7 @@
 			// and fallback to the raw wpTextbox1 since editconflicts can't be
 			// resolved between page source edits and custom ui edits using the
 			// custom edit ui.
-			$this->showTextbox1( null, $this->getContent() );
+			$this->showTextbox1( null );
 		} else {
 			$this->showContentForm();
 		}
@@ -1539,7 +1542,8 @@
 	protected function showHeader() {
 		global $wgOut, $wgUser, $wgMaxArticleSize, $wgLang;
 		if ( $this->isConflict ) {
-			$wgOut->wrapWikiMsg( "<div class='mw-explainconflict'>\n$1\n</div>", 'explainconflict' );
+			$wgOut->wrapWikiMsg( "<div class='mw-explainconflict'>\n$1\n</div>",
+				$this->mMergeAvailable ? 'explainconflictmerged' : 'explainconflict' );
 			$this->edittime = $this->mArticle->getTimestamp();
 		} else {
 			if ( $this->section != '' && !$this->isSectionEditSupported() ) {
@@ -1841,11 +1845,11 @@
 		$this->showTextbox( isset($textoverride) ? $textoverride : $this->textbox1, 'wpTextbox1', $attribs );
 	}
 
-	protected function showTextbox2() {
+	public function showTextbox2() {
 		$this->showTextbox( $this->textbox2, 'wpTextbox2', array( 'tabindex' => 6, 'readonly' ) );
 	}
 
-	protected function showTextbox( $content, $name, $customAttribs = array() ) {
+	public function showTextbox( $content, $name, $customAttribs = array() ) {
 		global $wgOut, $wgUser;
 
 		$wikitext = $this->safeUnicodeOutput( $content );
@@ -1992,16 +1996,15 @@
 	 */
 	protected function showConflict() {
 		global $wgOut;
-		$this->textbox2 = $this->textbox1;
-		$this->textbox1 = $this->getContent();
 		if ( wfRunHooks( 'EditPageBeforeConflictDiff', array( &$this, &$wgOut ) ) ) {
+			$this->textbox2 = $this->getContent();
 			$wgOut->wrapWikiMsg( '<h2>$1</h2>', "yourdiff" );
 
 			$de = new DifferenceEngine( $this->mTitle );
-			$de->setText( $this->textbox2, $this->textbox1 );
+			$de->setText( $this->textbox1, $this->getContent() );
 			$de->showDiff( wfMsg( "yourtext" ), wfMsg( "storedversion" ) );
 
-			$wgOut->wrapWikiMsg( '<h2>$1</h2>', "yourtext" );
+			$wgOut->wrapWikiMsg( '<h2>$1</h2>', "storedversion" );
 			$this->showTextbox2();
 		}
 	}
diff -r 6b6371ec1416 -r 1cd1a4762366 includes/GlobalFunctions.php
--- includes/GlobalFunctions.php
+++ includes/GlobalFunctions.php
@@ -1848,7 +1848,7 @@
 
 	if( !$haveDiff3 ) {
 		wfDebug( "diff3 not found\n" );
-		return false;
+		return NULL;
 	}
 
 	# Make temporary files
@@ -1857,6 +1857,10 @@
 	$mytextFile = fopen( $mytextName = tempnam( $td, 'merge-mine-' ), 'w' );
 	$yourtextFile = fopen( $yourtextName = tempnam( $td, 'merge-your-' ), 'w' );
 
+	if ($old{-1} != "\n") $old .= "\n";
+	if ($mine{-1} != "\n") $mine .= "\n";
+	if ($yours{-1} != "\n") $yours .= "\n";
+
 	fwrite( $oldtextFile, $old );
 	fclose( $oldtextFile );
 	fwrite( $mytextFile, $mine );
@@ -1879,8 +1883,10 @@
 	pclose( $handle );
 
 	# Merge differences
-	$cmd = $wgDiff3 . ' -a -e --merge ' .
-		wfEscapeShellArg( $mytextName, $oldtextName, $yourtextName );
+	$cmd = $wgDiff3 . ' -a -A --merge ' . wfEscapeShellArg(
+		'-L', wfMsg( 'merge-mine' ), '-L', wfMsg( 'merge-old' ),
+		'-L', wfMsg( 'merge-their' ), $mytextName, $oldtextName, $yourtextName
+	);
 	$handle = popen( $cmd, 'r' );
 	$result = '';
 	do {
