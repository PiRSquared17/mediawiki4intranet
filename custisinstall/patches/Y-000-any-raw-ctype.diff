# HG changeset patch
# User Vitaliy Filippov <vitalif@yourcmc.ru>
# Date 1327949194 -14400
Bug 76186 - (optional) Allow any content type for action=raw

diff -r 6b6371ec1416 -r dee274029aff includes/RawPage.php
--- includes/RawPage.php
+++ includes/RawPage.php
@@ -24,11 +24,13 @@
 	var $mContentType, $mExpandTemplates;
 
 	function __construct( Page $article, $request = false ) {
-		global $wgRequest, $wgSquidMaxage, $wgJsMimeType, $wgGroupPermissions;
+		global $wgRequest, $wgSquidMaxage, $wgJsMimeType, $wgGroupPermissions, $wgAllowedRawCTypes;
 
-		$allowedCTypes = array( 'text/x-wiki', $wgJsMimeType, 'text/css', 'application/x-zope-edit' );
+		$allowedCTypes = $wgAllowedRawCTypes
+			? $wgAllowedRawCTypes
+			: array( 'text/x-wiki', $wgJsMimeType, 'text/css', 'application/x-zope-edit' );
 		$this->mArticle = $article;
-		$this->mTitle = $article->getTitle();
+		$this->mTitle = $article->mTitle;
 
 		if( $request === false ) {
 			$this->mRequest = $wgRequest;
@@ -108,7 +110,8 @@
 			$this->mPrivateCache = false;
 		}
 
-		if( $ctype == '' || !in_array( $ctype, $allowedCTypes ) ) {
+		// Allow any content type for action=raw when $wgAllowedRawCTypes === true
+		if( $ctype == '' || $allowedCTypes !== true && !in_array( $ctype, $allowedCTypes ) ) {
 			$this->mContentType = 'text/x-wiki';
 		} else {
 			$this->mContentType = $ctype;
@@ -116,7 +119,7 @@
 	}
 
 	function view() {
-		global $wgOut, $wgRequest;
+		global $wgOut, $wgRequest, $wgTitle, $wgContLanguageCode;
 
 		if( !$wgRequest->checkUrlExtension() ) {
 			$wgOut->disable();
@@ -124,6 +127,7 @@
 		}
 
 		header( 'Content-type: ' . $this->mContentType . '; charset=' . $this->mCharset );
+		header( "Content-disposition: attachment; filename*=utf-8'$wgContLanguageCode'".urlencode( $wgTitle->getSubpageText() ) );
 		# allow the client to cache this for 24 hours
 		$mode = $this->mPrivateCache ? 'private' : 'public';
 		header( 'Cache-Control: ' . $mode . ', s-maxage=' . $this->mSmaxage . ', max-age=' . $this->mMaxage );
