# HG changeset patch
# User Vitaliy Filippov <vitalif@yourcmc.ru>
# Date 1327950432 -14400
Bug 67060 - Do not treat </?blockquote> and </?center> as paragraphs
Bug 68935 - Update for MediaWiki 1.16
MediaWikiBug 6200 (https://bugzilla.wikimedia.org/show_bug.cgi?id=6200) - Completely rewrite doBlockLevels to correctly handle nested tags

diff -r 6b6371ec1416 -r 5bf877308089 extensions/Cite/citeParserTests.txt
--- extensions/Cite/citeParserTests.txt
+++ extensions/Cite/citeParserTests.txt
@@ -22,8 +22,7 @@
 <references/>
 !! result
 <p>Wikipedia rocks!<sup id="cite_ref-0" class="reference"><a href="#cite_note-0">[1]</a></sup>
-</p>
-<ol class="references"><li id="cite_note-0"><a href="#cite_ref-0">↑</a> Proceeds of Rockology, vol. XXI</li></ol>
+</p><ol class="references"><li id="cite_note-0"><a href="#cite_ref-0">↑</a> Proceeds of Rockology, vol. XXI</li></ol>
 
 !! end
 
@@ -43,8 +42,7 @@
 <references/>
 !! result
 <p>Templating<sup id="cite_ref-0" class="reference"><a href="#cite_note-0">[1]</a></sup>
-</p>
-<ol class="references"><li id="cite_note-0"><a href="#cite_ref-0">↑</a> A <i>simple</i> template.</li></ol>
+</p><ol class="references"><li id="cite_note-0"><a href="#cite_ref-0">↑</a> A <i>simple</i> template.</li></ol>
 
 !! end
 
@@ -56,8 +54,7 @@
 <references/>
 !! result
 <p>Templating<sup id="cite_ref-0" class="reference"><a href="#cite_note-0">[1]</a></sup>
-</p>
-<ol class="references"><li id="cite_note-0"><a href="#cite_ref-0">↑</a> {{simple template}}</li></ol>
+</p><ol class="references"><li id="cite_note-0"><a href="#cite_ref-0">↑</a> {{simple template}}</li></ol>
 
 !! end
 
@@ -70,8 +67,7 @@
 <references/>
 !! result
 <p>Templating&lt;ref&gt;{{simple template}}&lt;/ref&gt;
-</p><p><br />
-</p>
+</p><p><br /></p>
 !! end
 
 !! test
@@ -82,8 +78,7 @@
 <references/>
 !! result
 <p>Templating
-</p><p><br />
-</p>
+</p><p><br /></p>
 !! end
 
 !! test
@@ -94,8 +89,7 @@
 <references/>
 !! result
 <p>Templating<sup id="cite_ref-0" class="reference"><a href="#cite_note-0">[1]</a></sup>
-</p>
-<ol class="references"><li id="cite_note-0"><a href="#cite_ref-0">↑</a> Text</li></ol>
+</p><ol class="references"><li id="cite_note-0"><a href="#cite_ref-0">↑</a> Text</li></ol>
 
 !! end
 
@@ -109,8 +103,7 @@
 <references/>
 !! result
 <p><sup id="cite_ref-0" class="reference"><a href="#cite_note-0">[1]</a></sup>
-</p>
-<ul class="gallery">
+</p><ul class="gallery">
 		<li class="gallerybox" style="width: 155px"><div style="width: 155px">
 			<div class="thumb" style="width: 150px;"><div style="margin:68px auto;"><a href="/wiki/File:Foobar.jpg" class="image"><img alt="Foobar.jpg" src="http://example.com/images/3/3a/Foobar.jpg" width="120" height="14" /></a></div></div>
 			<div class="gallerytext">
@@ -151,8 +144,7 @@
 !! result
 <p><sup id="cite_ref-blank_0-0" class="reference"><a href="#cite_note-blank-0">[1]</a></sup>
 </p><p><sup id="cite_ref-blank_0-1" class="reference"><a href="#cite_note-blank-0">[1]</a></sup>
-</p>
-<ol class="references"><li id="cite_note-blank-0">↑ <sup><a href="#cite_ref-blank_0-0">1.0</a></sup> <sup><a href="#cite_ref-blank_0-1">1.1</a></sup> content</li></ol>
+</p><ol class="references"><li id="cite_note-blank-0">↑ <sup><a href="#cite_ref-blank_0-0">1.0</a></sup> <sup><a href="#cite_ref-blank_0-1">1.1</a></sup> content</li></ol>
 
 !! end
 
@@ -167,8 +159,7 @@
 !! result
 <p><sup id="cite_ref-blank_0-0" class="reference"><a href="#cite_note-blank-0">[1]</a></sup>
 </p><p><sup id="cite_ref-blank_0-1" class="reference"><a href="#cite_note-blank-0">[1]</a></sup>
-</p>
-<ol class="references"><li id="cite_note-blank-0">↑ <sup><a href="#cite_ref-blank_0-0">1.0</a></sup> <sup><a href="#cite_ref-blank_0-1">1.1</a></sup> 0</li></ol>
+</p><ol class="references"><li id="cite_note-blank-0">↑ <sup><a href="#cite_ref-blank_0-0">1.0</a></sup> <sup><a href="#cite_ref-blank_0-1">1.1</a></sup> 0</li></ol>
 
 !! end
 
@@ -183,8 +174,7 @@
 !! result
 <p><sup id="cite_ref-blank_0-0" class="reference"><a href="#cite_note-blank-0">[1]</a></sup>
 </p><p><sup id="cite_ref-blank_0-1" class="reference"><a href="#cite_note-blank-0">[1]</a></sup>
-</p>
-<ol class="references"><li id="cite_note-blank-0">↑ <sup><a href="#cite_ref-blank_0-0">1.0</a></sup> <sup><a href="#cite_ref-blank_0-1">1.1</a></sup> 1</li></ol>
+</p><ol class="references"><li id="cite_note-blank-0">↑ <sup><a href="#cite_ref-blank_0-0">1.0</a></sup> <sup><a href="#cite_ref-blank_0-1">1.1</a></sup> 1</li></ol>
 
 !! end
 
@@ -200,8 +190,7 @@
 <p><sup id="cite_ref-test123test_0-0" class="reference"><a href="#cite_note-test123test-0">[1]</a></sup>
 <sup id="cite_ref-123test_1-0" class="reference"><a href="#cite_note-123test-1">[2]</a></sup>
 <sup id="cite_ref-test123_2-0" class="reference"><a href="#cite_note-test123-2">[3]</a></sup>
-</p>
-<ol class="references"><li id="cite_note-test123test-0"><a href="#cite_ref-test123test_0-0">↑</a> One</li>
+</p><ol class="references"><li id="cite_note-test123test-0"><a href="#cite_ref-test123test_0-0">↑</a> One</li>
 <li id="cite_note-123test-1"><a href="#cite_ref-123test_1-0">↑</a> Two</li>
 <li id="cite_note-test123-2"><a href="#cite_ref-test123_2-0">↑</a> Three</li></ol>
 
@@ -234,8 +223,7 @@
 </p><p><strong class="error">Cite error: Invalid <code>&lt;references&gt;</code> tag;
 parameter "group" is allowed only.
 Use <code>&lt;references /&gt;</code>, or <code>&lt;references group="..." /&gt;</code></strong>
-</p>
-<ol class="references"><li id="cite_note-0"><a href="#cite_ref-0">↑</a> Also zero, but differently! (Normal ref)</li>
+</p><ol class="references"><li id="cite_note-0"><a href="#cite_ref-0">↑</a> Also zero, but differently! (Normal ref)</li>
 <li id="cite_note-bar"><a href="#cite_ref-bar_0">↑</a> <strong class="error">Cite error: Invalid <code>&lt;ref&gt;</code> tag;
 no text was provided for refs named <code>bar</code></strong></li>
 <li id="cite_note-blankwithnoreference"><a href="#cite_ref-blankwithnoreference_0">↑</a> <strong class="error">Cite error: Invalid <code>&lt;ref&gt;</code> tag;
@@ -255,8 +243,7 @@
 !! result
 <p>Wikipedia rocks!<sup id="cite_ref-0" class="reference"><a href="#cite_note-0">[1]</a></sup>
 Wikipedia rocks!<sup id="cite_ref-1" class="reference"><a href="#cite_note-1">[note 1]</a></sup>
-</p>
-<ol class="references"><li id="cite_note-0"><a href="#cite_ref-0">↑</a> Proceeds of Rockology, vol. XXI</li></ol>
+</p><ol class="references"><li id="cite_note-0"><a href="#cite_ref-0">↑</a> Proceeds of Rockology, vol. XXI</li></ol>
 <ol class="references"><li id="cite_note-1"><a href="#cite_ref-1">↑</a> Proceeds of Rockology, vol. XXI</li></ol>
 
 !! end
@@ -272,8 +259,7 @@
 <references group="注" />
 !! result
 <p>AAA<sup id="cite_ref-0" class="reference"><a href="#cite_note-0">[参 1]</a></sup>BBB<sup id="cite_ref-1" class="reference"><a href="#cite_note-1">[注 1]</a></sup>CCC<sup id="cite_ref-2" class="reference"><a href="#cite_note-2">[参 2]</a></sup>
-</p>
-<dl><dt>refs
+</p><dl><dt>refs
 </dt></dl>
 <ol class="references"><li id="cite_note-0"><a href="#cite_ref-0">↑</a> ref a</li>
 <li id="cite_note-2"><a href="#cite_ref-2">↑</a> ref c</li></ol>
@@ -293,8 +279,7 @@
 </references>
 !! result
 <p><sup id="cite_ref-foo_0-0" class="reference"><a href="#cite_note-foo-0">[1]</a></sup>
-</p>
-<ol class="references"><li id="cite_note-foo-0"><a href="#cite_ref-foo_0-0">↑</a> BAR</li></ol>
+</p><ol class="references"><li id="cite_note-foo-0"><a href="#cite_ref-foo_0-0">↑</a> BAR</li></ol>
 
 !! end
 
@@ -308,8 +293,7 @@
 }}
 !! result
 <p><sup id="cite_ref-foo_0-0" class="reference"><a href="#cite_note-foo-0">[1]</a></sup>
-</p>
-<ol class="references"><li id="cite_note-foo-0"><a href="#cite_ref-foo_0-0">↑</a> BAR</li></ol>
+</p><ol class="references"><li id="cite_note-foo-0"><a href="#cite_ref-foo_0-0">↑</a> BAR</li></ol>
 
 !! end
 
@@ -326,8 +310,7 @@
 </references>
 !! result
 <p><sup id="cite_ref-foo_0-0" class="reference"><a href="#cite_note-foo-0">[2 1]</a></sup>
-</p>
-<ol class="references"><li id="cite_note-foo"><a href="#cite_ref-foo_0">↑</a> <strong class="error">Cite error: Invalid <code>&lt;ref&gt;</code> tag;
+</p><ol class="references"><li id="cite_note-foo"><a href="#cite_ref-foo_0">↑</a> <strong class="error">Cite error: Invalid <code>&lt;ref&gt;</code> tag;
 no text was provided for refs named <code>foo</code></strong></li></ol>
 <p><strong class="error">Cite error: <code>&lt;ref&gt;</code> tag with name "unused" defined in <code>&lt;references&gt;</code> is not used in prior text.</strong><br />
 <strong class="error">Cite error: <code>&lt;ref&gt;</code> tag in <code>&lt;references&gt;</code> has conflicting group attribute "1".</strong><br />
@@ -349,7 +332,6 @@
 <references group="klingon"/>
 !! result
 <p>Wikipedia rocks!<sup id="cite_ref-0" class="reference"><a href="#cite_note-0">[wa']</a></sup>
-</p>
-<ol class="references"><li id="cite_note-0"><a href="#cite_ref-0">↑</a> Proceeds of Rockology, vol. XXI</li></ol>
+</p><ol class="references"><li id="cite_note-0"><a href="#cite_ref-0">↑</a> Proceeds of Rockology, vol. XXI</li></ol>
 
 !! end
diff -r 6b6371ec1416 -r 5bf877308089 includes/parser/Parser.php
--- includes/parser/Parser.php
+++ includes/parser/Parser.php
@@ -1963,7 +1963,7 @@
 	 * @return Boolean
 	 */
 	function areSubpagesAllowed() {
-		# Some namespaces don't allow subpages
+		// Some namespaces don't allow subpages
 		return MWNamespace::hasSubpages( $this->mTitle->getNamespace() );
 	}
 
@@ -1988,7 +1988,7 @@
 	function closeParagraph() {
 		$result = '';
 		if ( $this->mLastSection != '' ) {
-			$result = '</' . $this->mLastSection  . ">\n";
+			$result = '</' . $this->mLastSection  . ">";
 		}
 		$this->mInPre = false;
 		$this->mLastSection = '';
@@ -2111,16 +2111,69 @@
 		$textLines = StringUtils::explode( "\n", $text );
 
 		$lastPrefix = $output = '';
-		$this->mDTopen = $inBlockElem = false;
+		$this->mDTopen = false;
 		$prefixLength = 0;
-		$paragraphStack = false;
+
+		// 0     = always start paragraph for a piece of text or inline tag
+		// 1     = some text of current paragraph already printed inline,
+		//         so persist 1 across newline and print text from there inline also
+		// 2     = print text inline if there is some, but reset to 0 at newline if not
+		$dontStartParagraph = 0;
+
+		// the output position of last paragraph start
+		$lastParagraphPos = NULL;
+
+		// 'p'   = inside a paragraph
+		// 'div' = inside a <div class="paragraph">
+		// 'pre' = inside preformatted lines (with space at beginning)
+		$this->mLastSection = '';
+
+		// true  = inside a <pre> tag
+		$this->mInPre = false;
+
+		// > 0   = inside a $noPre tag
+		$inNoPre = 0;
+
+		// <div class="paragraph"> can itself contain paragraphs, so this is a stack of them
+		$nestedSections = array();
+
+		// empty lines counter
+		$emptyLines = 0;
+
+		// Block elements force to close current paragraph
+		$closesParagraph = array(
+			'div' => 1,
+			'center' => 1,
+			'table' => 1,
+			'caption' => 1,
+			'tr' => 1,
+			'td' => 1,
+			'th' => 1,
+			'h1' => 1,
+			'h2' => 1,
+			'h3' => 1,
+			'h4' => 1,
+			'h5' => 1,
+			'h6' => 1,
+			'hr' => 1,
+			'ul' => 1,
+			'ol' => 1,
+			'li' => 1,
+			'pre' => 1,
+			'p' => 1,
+			'blockquote' => 1,
+			'script' => 1,
+		);
+
+		// These elements disallow preformatting by adding space at the beginning of line
+		$noPre = array(
+			'table' => 1,
+			'pre' => 1,
+		);
 
 		foreach ( $textLines as $oLine ) {
-			# Fix up $linestart
 			if ( !$linestart ) {
-				$output .= $oLine;
-				$linestart = true;
-				continue;
+				$dontStartParagraph = 1;
 			}
 			# * = ul
 			# # = ol
@@ -2128,11 +2181,9 @@
 			# : = dd
 
 			$lastPrefixLength = strlen( $lastPrefix );
-			$preCloseMatch = preg_match( '/<\\/pre/i', $oLine );
-			$preOpenMatch = preg_match( '/<pre/i', $oLine );
-			# If not in a <pre> element, scan for and figure out what prefixes are there.
-			if ( !$this->mInPre ) {
-				# Multiple prefixes may abut each other for nested lists.
+			// If at line start and not in a <pre> element, scan for and figure out what prefixes are there.
+			if ( $linestart && !$this->mInPre ) {
+				// Multiple prefixes may abut each other for nested lists.
 				$prefixLength = strspn( $oLine, '*#:;' );
 				$prefix = substr( $oLine, 0, $prefixLength );
 
@@ -2142,7 +2193,6 @@
 				#  elements.
 				$prefix2 = str_replace( ';', ':', $prefix );
 				$t = substr( $oLine, $prefixLength );
-				$this->mInPre = (bool)$preOpenMatch;
 			} else {
 				# Don't interpret any other prefixes in preformatted text
 				$prefixLength = 0;
@@ -2153,8 +2203,9 @@
 			# List generation
 			if ( $prefixLength && $lastPrefix === $prefix2 ) {
 				# Same as the last item, so no need to deal with nesting or opening stuff
+				$output .= $this->closeParagraph();
+				$dontStartParagraph = 2;
 				$output .= $this->nextItem( substr( $prefix, -1 ) );
-				$paragraphStack = false;
 
 				if ( substr( $prefix, -1 ) === ';') {
 					# The one nasty exception: definition lists work like this:
@@ -2167,12 +2218,17 @@
 						$output .= $term . $this->nextItem( ':' );
 					}
 				}
+
+				// Reset linestart to false to ignore heading space
+				$linestart = false;
+				$emptyLines = 0;
 			} elseif ( $prefixLength || $lastPrefixLength ) {
+				$output .= $this->closeParagraph();
+				$dontStartParagraph = $prefixLength ? 2 : 0;
 				# We need to open or close prefixes, or both.
 
 				# Either open or close a level...
 				$commonPrefixLength = $this->getCommon( $prefix, $lastPrefix );
-				$paragraphStack = false;
 
 				# Close all the prefixes which aren't shared.
 				while ( $commonPrefixLength < $lastPrefixLength ) {
@@ -2200,71 +2256,148 @@
 					++$commonPrefixLength;
 				}
 				$lastPrefix = $prefix2;
+
+				// Reset linestart to false to ignore heading space
+				$linestart = !$prefixLength;
+				$emptyLines = 0;
 			}
 
-			# If we have no prefixes, go to paragraph mode.
-			if ( 0 == $prefixLength ) {
-				wfProfileIn( __METHOD__."-paragraph" );
-				# No prefix (not in list)--go to paragraph mode
-				# XXX: use a stack for nestable elements like span, table and div
-				$openmatch = preg_match('/(?:<table|<blockquote|<h1|<h2|<h3|<h4|<h5|<h6|<pre|<tr|<p|<ul|<ol|<li|<\\/tr|<\\/td|<\\/th)/iS', $t );
-				$closematch = preg_match(
-					'/(?:<\\/table|<\\/blockquote|<\\/h1|<\\/h2|<\\/h3|<\\/h4|<\\/h5|<\\/h6|'.
-					'<td|<th|<\\/?div|<hr|<\\/pre|<\\/p|'.$this->mUniqPrefix.'-pre|<\\/li|<\\/ul|<\\/ol|<\\/?center)/iS', $t );
-				if ( $openmatch or $closematch ) {
-					$paragraphStack = false;
-					# TODO bug 5718: paragraph closed
-					$output .= $this->closeParagraph();
-					if ( $preOpenMatch and !$preCloseMatch ) {
-						$this->mInPre = true;
+			// Go to paragraph mode.
+			wfProfileIn( __METHOD__."-paragraph" );
+			if ( $linestart && $inNoPre <= 0 && ' ' == substr( $t, 0, 1 ) &&
+				( $this->mLastSection === 'pre' || trim( $t ) != '' ) ) {
+				// <pre>formatted text
+				$emptyLines = 0;
+				if ( $this->mLastSection !== 'pre' ) {
+					$output .= $this->closeParagraph().'<pre>';
+					$this->mLastSection = 'pre';
+				}
+				$output .= substr( $t, 1 ) . "\n";
+			} elseif ( !$this->mInPre && trim( $t ) === '' ) {
+				// close paragraph
+				$output .= $this->closeParagraph();
+				$dontStartParagraph = 0;
+				$emptyLines++;
+				if ( $emptyLines > 1 ) {
+					// start a new paragraph
+					$lastParagraphPos = strlen( $output );
+					$this->mLastSection = 'p';
+					$output .= '<p><br />';
+					$emptyLines = 0;
+				}
+			} else {
+				$emptyLines = 0;
+				while ( strlen( $t ) ) {
+					// match html tag or preformatted block hidden by link holder
+					// <html> does not influence on paragraphs in any way, so we don't match it
+					if ( preg_match( '/<(\/?)([a-z][a-z0-9]*).*?(\/?)>|('.$this->mUniqPrefix.
+						'-pre.*?'.self::MARKER_SUFFIX.')/iS', $t, $m, PREG_OFFSET_CAPTURE ) ) {
+						$textBefore = substr( $t, 0, $m[0][1] );
+						$t = substr( $t, $m[0][1] + strlen( $m[0][0] ) );
+						if ( $m[2][0] && empty( $closesParagraph[ $m[2][0] ] ) ) {
+							$textBefore .= $m[0][0];
+							$m[0][0] = '';
+						}
+					} else {
+						$textBefore = $t;
+						$t = '';
 					}
-					$inBlockElem = !$closematch;
-				} elseif ( !$inBlockElem && !$this->mInPre ) {
-					if ( ' ' == substr( $t, 0, 1 ) and ( $this->mLastSection === 'pre' || trim( $t ) != '' ) ) {
-						# pre
-						if ( $this->mLastSection !== 'pre' ) {
-							$paragraphStack = false;
-							$output .= $this->closeParagraph().'<pre>';
-							$this->mLastSection = 'pre';
-						}
-						$t = substr( $t, 1 );
-					} else {
-						# paragraph
-						if ( trim( $t ) === '' ) {
-							if ( $paragraphStack ) {
-								$output .= $paragraphStack.'<br />';
-								$paragraphStack = false;
-								$this->mLastSection = 'p';
-							} else {
-								if ( $this->mLastSection !== 'p' ) {
+					$match = isset( $m[0] ) ? $m[0][0] : false;
+					$close = isset( $m[1] ) ? $m[1][0] : false;
+					$tag   = isset( $m[2] ) ? $m[2][0] : false;
+					$empty = isset( $m[3] ) ? $m[3][0] : false;
+					$uniq  = isset( $m[4] ) ? $m[4][0] : false;
+					if ( $textBefore !== '' ) {
+						// Here is the place where the text gets inside <p>aragraphs
+						if ( trim( $textBefore ) !== '' ) {
+							if ( !$this->mInPre && !$dontStartParagraph ) {
+								if ( $this->mLastSection == 'pre' ) {
 									$output .= $this->closeParagraph();
-									$this->mLastSection = '';
-									$paragraphStack = '<p>';
-								} else {
-									$paragraphStack = '</p><p>';
+								}
+								if ( !$this->mLastSection && !$this->mInPre ) {
+									$lastParagraphPos = strlen( $output );
+									$output .= '<p>';
+									$this->mLastSection = 'p';
 								}
 							}
-						} else {
-							if ( $paragraphStack ) {
-								$output .= $paragraphStack;
-								$paragraphStack = false;
-								$this->mLastSection = 'p';
-							} elseif ( $this->mLastSection !== 'p' ) {
-								$output .= $this->closeParagraph().'<p>';
-								$this->mLastSection = 'p';
+							elseif ( $dontStartParagraph == 2 ) {
+								$dontStartParagraph = 1;
+							}
+						}
+						$output .= $textBefore;
+					}
+					if ( $this->mInPre && $close && $tag == 'pre' ) {
+						// this is </pre> closing tag
+						$this->mInPre = false;
+						$inNoPre--;
+					} elseif ( $uniq ) {
+						// UNIQ <pre> closes paragraph
+						$output .= $this->closeParagraph();
+					} elseif ( !empty( $closesParagraph[ $tag ] ) ) {
+						// block element closes current paragraph
+						if ( $tag != 'div' ) {
+							// <div> does not close the paragraph,
+							// but turns it into a <div class="paragraph">
+							$output .= $this->closeParagraph();
+						} elseif ( !$empty ) {
+							// <div> is the only case of nested "paragraphs"
+							if ( $close ) {
+								// </div> - close current nesting level
+								$output .= $this->closeParagraph();
+								list( $this->mLastSection, $inNoPre ) = array_pop( $nestedSections );
+							} else {
+								// <div> - start a nested level
+								if ( $this->mLastSection == 'p' && $tag == 'div' ) {
+									// <div> can not be used inside <p>
+									// so turn last <p> into a <div class="paragraph">
+									$output =
+										substr( $output, 0, $lastParagraphPos ) .
+										'<div class="paragraph">' .
+										substr( $output, $lastParagraphPos+3 );
+									$this->mLastSection = 'div';
+								}
+								$nestedSections[] = array( $this->mLastSection, $inNoPre );
+								$this->mLastSection = '';
+								$inNoPre = 0;
+							}
+						}
+						// if not an enclosed XML element
+						if ( !$empty ) {
+							if ( !empty( $noPre[ $tag ] ) ) {
+								$inNoPre += $close ? -1 : 1;
+							}
+							if ( !$close ) {
+								if ( !$this->mLastSection ) {
+									// do not start paragraph right after opening block
+									// element tag on the same line. I.e. <div>A</div> is parsed
+									// into <div>A</div>, and <div>\nA</div> is parsed
+									// into <div><p>A</p></div>
+									$dontStartParagraph = 2;
+								}
+								if ( $tag == 'pre' && !$empty ) {
+									$this->mInPre = true;
+								}
+							} elseif ( $dontStartParagraph ) {
+								// Current block element is closed
+								$dontStartParagraph = 2;
 							}
 						}
 					}
+					if ( $match !== '' ) {
+						$output .= $match;
+					}
 				}
-				wfProfileOut( __METHOD__."-paragraph" );
+				$output .= "\n";
+				// If line ended after opening block element tag with no text after it
+				// => allow to start a paragraph from next line
+				// If there was some text (dontStartParagraph == 1)
+				// => do not start a paragraph from next line
+				if ( $dontStartParagraph == 2 ) {
+					$dontStartParagraph = 0;
+				}
 			}
-			# somewhere above we forget to get out of pre block (bug 785)
-			if ( $preCloseMatch && $this->mInPre ) {
-				$this->mInPre = false;
-			}
-			if ( $paragraphStack === false ) {
-				$output .= $t."\n";
-			}
+			wfProfileOut( __METHOD__."-paragraph" );
+			$linestart = true;
 		}
 		while ( $prefixLength ) {
 			$output .= $this->closeList( $prefix2[$prefixLength-1] );
diff -r 6b6371ec1416 -r 5bf877308089 skins/chick/main.css
--- skins/chick/main.css
+++ skins/chick/main.css
@@ -31,8 +31,13 @@
 	margin: 0.4em 0em 0.5em 0em;
 	line-height: 1.5em;
 }
+div.paragraph {
+	margin: 0.4em 0em 0.5em 0em;
+	line-height: 1.5em;
+}
 
 p img { margin: 0; }
+div.paragraph img { margin: 0; }
 
 hr {
 	height: 1px;
@@ -190,6 +195,7 @@
 	padding: 0 0.9em 0 0.9em;
 }
 #siteNotice p { margin: 0; padding: 0; }
+#siteNotice div.paragraph { margin: 0; padding: 0; }
 .error {
 	color: red;
 	font-size: larger;
@@ -259,12 +265,14 @@
 	border-width: 0.5em 0 0.8em 1.4em;
 }
 div.floatright p { font-style: italic; }
+div.floatright div.paragraph { font-style: italic; }
 /* @noflip */div.floatleft, table.floatleft {
 	margin: 0.3em 0.5em 0.5em 0;
 	border: 0.5em solid white;
 	border-width: 0.5em 1.4em 0.8em 0;
 }
 div.floatleft p { font-style: italic; }
+div.floatleft div.paragraph { font-style: italic; }
 /* thumbnails */
 div.thumb {
 	margin-bottom: 0.5em;
diff -r 6b6371ec1416 -r 5bf877308089 skins/cologneblue/screen.css
--- skins/cologneblue/screen.css
+++ skins/cologneblue/screen.css
@@ -44,6 +44,11 @@
 	font-size: 10pt;
 	color: black;
 }
+#article, #article td, #article th, #article div.paragraph {
+	font-family: Verdana, Arial, sans-serif;
+	font-size: 10pt;
+	color: black;
+}
 
 #article p {
 	padding-top: 0;
@@ -51,6 +56,12 @@
 	margin-top: 1ex;
 	margin-bottom: 0;
 }
+#article div.paragraph {
+	padding-top: 0;
+	padding-bottom: 0;
+	margin-top: 1ex;
+	margin-bottom: 0;
+}
 
 p, pre, td, th, li, dd, dt {
 	line-height: 12pt;
@@ -191,6 +202,14 @@
 	margin-top: 0;
 	padding-bottom: 1ex;
 }
+#article div.paragraph.subtitle {
+	color: #666666;
+	font-size: 11pt;
+	font-weight: bold;
+	padding-top: 0;
+	margin-top: 0;
+	padding-bottom: 1ex;
+}
 
 a {
 	color: #223366;
diff -r 6b6371ec1416 -r 5bf877308089 skins/common/commonPrint.css
--- skins/common/commonPrint.css
+++ skins/common/commonPrint.css
@@ -35,6 +35,9 @@
 div.floatright p {
 	font-style: italic;
 }
+div.floatright div.paragraph {
+	font-style: italic;
+}
 div.floatleft {
 	float: left;
 	clear: left;
@@ -44,6 +47,9 @@
 div.floatleft p {
 	font-style: italic;
 }
+div.floatleft div.paragraph {
+	font-style: italic;
+}
 div.center {
 	text-align: center;
 }
@@ -163,6 +169,9 @@
 .tocindent p {
 	margin: 0 0 0 0 ! important;
 }
+.tocindent div.paragraph {
+	margin: 0 0 0 0 ! important;
+}
 
 pre {
 	border: 1pt dashed black;
@@ -345,6 +354,10 @@
 	widows: 3;
 	orphans: 3;
 }
+div.paragraph {
+	widows: 3;
+	orphans: 3;
+}
 
 /**
  * Categories
diff -r 6b6371ec1416 -r 5bf877308089 skins/common/config-cc.css
--- skins/common/config-cc.css
+++ skins/common/config-cc.css
@@ -49,6 +49,9 @@
 #menu p { 
 	font-size:11px;
 }
+#menu div.paragraph { 
+	font-size:11px;
+}
 
 .dent {
 	margin-left:64px;
diff -r 6b6371ec1416 -r 5bf877308089 skins/common/oldshared.css
--- skins/common/oldshared.css
+++ skins/common/oldshared.css
@@ -41,6 +41,9 @@
 div.floatright p {
 	font-style: italic;
 }
+div.floatright div.paragraph {
+	font-style: italic;
+}
 
 /* @noflip */
 div.floatleft {
@@ -53,6 +56,9 @@
 div.floatleft p {
 	font-style: italic;
 }
+div.floatleft div.paragraph {
+	font-style: italic;
+}
 
 
 /* Print-specific things to hide */
diff -r 6b6371ec1416 -r 5bf877308089 skins/common/shared.css
--- skins/common/shared.css
+++ skins/common/shared.css
@@ -214,6 +214,12 @@
 	font-size: 90%;
 	text-align: right;
 }
+p.mw-ipb-conveniencelinks, div.paragraph.mw-protect-editreasons,
+p.mw-filedelete-editreasons, p.mw-delete-editreasons,
+p.mw-revdel-editreasons {
+	font-size: 90%;
+	text-align: right;
+}
 
 /*
  * OpenSearch ajax suggestions
@@ -452,6 +458,10 @@
 	text-indent: 3em;
 	margin: 0.8em 0;
 }
+.previewnote div.paragraph {
+	text-indent: 3em;
+	margin: 0.8em 0;
+}
 
 .visualClear {
 	clear: both;
diff -r 6b6371ec1416 -r 5bf877308089 skins/common/wikiprintable.css
--- skins/common/wikiprintable.css
+++ skins/common/wikiprintable.css
@@ -43,4 +43,5 @@
 h1.pagetitle { padding-bottom: 0; margin-bottom: 0; }
 i.link, u.link { color: #000066; }
 p.subtitle { padding-top: 0; margin-top: 0; }
+div.paragraph.subtitle { padding-top: 0; margin-top: 0; }
 */
diff -r 6b6371ec1416 -r 5bf877308089 skins/common/wikistandard.css
--- skins/common/wikistandard.css
+++ skins/common/wikistandard.css
@@ -153,11 +153,18 @@
 p.subpages {
 	font-size: small;
 }
+div.paragraph.subpages {
+	font-size: small;
+}
 
 p.subtitle {
 	padding-top: 0;
 	margin-top: 0;
 }
+div.paragraph.subtitle {
+	padding-top: 0;
+	margin-top: 0;
+}
 
 .catlinks {
 	font-size: small;
diff -r 6b6371ec1416 -r 5bf877308089 skins/modern/main.css
--- skins/modern/main.css
+++ skins/modern/main.css
@@ -286,6 +286,9 @@
 p {
 	margin: 1em 0 1em 0;
 }
+div.paragraph {
+	margin: 1em 0 1em 0;
+}
 
 hr {
 	height: 1px;
@@ -486,6 +489,7 @@
 */
 }
 div.floatright p { font-style: italic; }
+div.floatright div.paragraph { font-style: italic; }
 /* @noflip */div.floatleft, table.floatleft {
 	margin: 0 .5em .5em 0;
 	border: 0;
@@ -496,6 +500,7 @@
 */
 }
 div.floatleft p { font-style: italic; }
+div.floatleft div.paragraph { font-style: italic; }
 /* thumbnails */
 div.thumb {
 	margin-bottom: .5em;
@@ -658,6 +663,10 @@
 	margin: 0;
 	padding: 0;
 }
+.previewnote div.paragraph {
+	margin: 0;
+	padding: 0;
+}
 
 .editExternally {
 	border: 1px solid gray;
@@ -843,6 +852,10 @@
 	padding: 0 0 0 0;
 	margin: 0 0 0 0;
 }
+.mw-topbox div.paragraph {
+	padding: 0 0 0 0;
+	margin: 0 0 0 0;
+}
 
 .mw-topbox {
 	color: black;
diff -r 6b6371ec1416 -r 5bf877308089 skins/monobook/main.css
--- skins/monobook/main.css
+++ skins/monobook/main.css
@@ -95,9 +95,16 @@
 	margin: .4em 0 .5em 0;
 	line-height: 1.5em;
 }
+div.paragraph {
+	margin: .4em 0 .5em 0;
+	line-height: 1.5em;
+}
 p img {
 	margin: 0;
 }
+div.paragraph img {
+	margin: 0;
+}
 
 hr {
 	height: 1px;
@@ -276,6 +283,10 @@
 	margin: 0;
 	padding: 0;
 }
+#siteNotice div.paragraph {
+	margin: 0;
+	padding: 0;
+}
 
 .catlinks {
 	border: 1px solid #aaa;
@@ -377,6 +388,7 @@
 */
 }
 div.floatright p { font-style: italic; }
+div.floatright div.paragraph { font-style: italic; }
 /* @noflip */div.floatleft, table.floatleft {
 	margin: 0 .5em .5em 0;
 	border: 0;
@@ -387,6 +399,7 @@
 */
 }
 div.floatleft p { font-style: italic; }
+div.floatleft div.paragraph { font-style: italic; }
 /* thumbnails */
 div.thumb {
 	margin-bottom: .5em;
@@ -1180,6 +1193,9 @@
 #powersearch p {
 	margin-top:0px;
 }
+#powersearch div.paragraph {
+	margin-top:0px;
+}
 
 div.multipageimagenavbox {
 	border: solid 1px silver;
diff -r 6b6371ec1416 -r 5bf877308089 skins/nostalgia/screen.css
--- skins/nostalgia/screen.css
+++ skins/nostalgia/screen.css
@@ -46,6 +46,10 @@
 	padding-top: 0;
 	margin-top: 0;
 }
+div.paragraph.subtitle {
+	padding-top: 0;
+	margin-top: 0;
+}
 div.sitenotice {
 	clear: both;
 }
diff -r 6b6371ec1416 -r 5bf877308089 skins/simple/main.css
--- skins/simple/main.css
+++ skins/simple/main.css
@@ -84,7 +84,12 @@
     margin: 0.4em 0em 0.5em 0em;
     line-height: 1.5em;
 }
+div.paragraph {
+    margin: 0.4em 0em 0.5em 0em;
+    line-height: 1.5em;
+}
 p img { margin: 0; }
+div.paragraph img { margin: 0; }
 
 h1, h2, h3, h4, h5, h6 {
     margin: 0;
@@ -260,11 +265,13 @@
     border-width: 0.5em 0 0.8em 1.4em;
 }
 div.floatright p { font-style: italic; }
+div.floatright div.paragraph { font-style: italic; }
 /* @noflip */div.floatleft, table.floatleft {
     margin: 0.3em 0.5em 0.5em 0;
     border-width: 0.5em 1.4em 0.8em 0;
 }
 div.floatleft p { font-style: italic; }
+div.floatleft div.paragraph { font-style: italic; }
 /* thumbnails */
 div.thumb {
     margin-bottom: 0.5em;
diff -r 6b6371ec1416 -r 5bf877308089 skins/vector/screen.css
--- skins/vector/screen.css
+++ skins/vector/screen.css
@@ -769,9 +769,16 @@
 	margin: .4em 0 .5em 0;
 	line-height: 1.5em;
 }
+div.paragraph {
+	margin: .4em 0 .5em 0;
+	line-height: 1.5em;
+}
 p img {
 	margin: 0;
 }
+div.paragraph img {
+	margin: 0;
+}
 q {
 	font-family: Times, "Times New Roman", serif;
 	font-style: italic;
@@ -903,11 +910,13 @@
 	border: 0;
 }
 div.floatright p { font-style: italic; }
+div.floatright div.paragraph { font-style: italic; }
 /* @noflip */div.floatleft, table.floatleft {
 	margin: 0 .5em .5em 0;
 	border: 0;
 }
 div.floatleft p { font-style: italic; }
+div.floatleft div.paragraph { font-style: italic; }
 /* Thumbnails */
 div.thumb {
 	margin-bottom: .5em;
diff -r 6b6371ec1416 -r 5bf877308089 tests/parser/parserTests.txt
--- tests/parser/parserTests.txt
+++ tests/parser/parserTests.txt
@@ -198,7 +198,6 @@
 !! result
 <pre>asdf
 </pre>
-
 !! end
 
 !! test
@@ -243,10 +242,8 @@
 c
 !! result
 <p>a
-</p>
-<pre> b 
-</pre>
-<p>c
+</p><pre> b 
+</pre><p>c
 </p>
 !! end
 
@@ -371,8 +368,7 @@
 !! result
 <center>
 <pre>Blah
-</pre>
-</center>
+</pre></center>
 
 !! end
 
@@ -1989,8 +1985,8 @@
 !! result 
 <hr />
 <hr />
-foo <hr /> bar
-
+<p>foo </p><hr /><p> bar
+</p>
 !! end
 
 ###
@@ -2692,8 +2688,8 @@
 {{paramtest|
   param =[[Image:noimage.png|thumb|[[no link|link]] [[no link|caption]]]]}}
 !! result
-This is a test template with parameter <div class="thumb tright"><div class="thumbinner" style="width:182px;"><a href="/index.php?title=Special:Upload&amp;wpDestFile=Noimage.png" class="new" title="File:Noimage.png">File:Noimage.png</a>  <div class="thumbcaption"><a href="/index.php?title=No_link&amp;action=edit&amp;redlink=1" class="new" title="No link (page does not exist)">link</a> <a href="/index.php?title=No_link&amp;action=edit&amp;redlink=1" class="new" title="No link (page does not exist)">caption</a></div></div></div>
-
+<div class="paragraph">This is a test template with parameter <div class="thumb tright"><div class="thumbinner" style="width:182px;"><a href="/index.php?title=Special:Upload&amp;wpDestFile=Noimage.png" class="new" title="File:Noimage.png">File:Noimage.png</a>  <div class="thumbcaption"><a href="/index.php?title=No_link&amp;action=edit&amp;redlink=1" class="new" title="No link (page does not exist)">link</a> <a href="/index.php?title=No_link&amp;action=edit&amp;redlink=1" class="new" title="No link (page does not exist)">caption</a></div></div></div>
+</div>
 !! end
 
 !! article
@@ -2830,8 +2826,7 @@
 foo {{table}}
 !! result
 <p>foo 
-</p>
-<table>
+</p><table>
 <tr>
 <td> 1 </td>
 <td> 2
@@ -2850,8 +2845,7 @@
 {{table}}
 !! result
 <p>foo
-</p>
-<table>
+</p><table>
 <tr>
 <td> 1 </td>
 <td> 2
@@ -4032,11 +4026,9 @@
 !! result
 <h2><span class="editsection">[<a href="/index.php?title=Parser_test&amp;action=edit&amp;section=1" title="Edit section: Headline 1">edit</a>]</span> <span class="mw-headline" id="Headline_1"> Headline 1 </span></h2>
 <p>Some text
-</p>
-<h2><span class="editsection">[<a href="/index.php?title=Parser_test&amp;action=edit&amp;section=2" title="Edit section: Headline 2">edit</a>]</span> <span class="mw-headline" id="Headline_2">Headline 2</span></h2>
+</p><h2><span class="editsection">[<a href="/index.php?title=Parser_test&amp;action=edit&amp;section=2" title="Edit section: Headline 2">edit</a>]</span> <span class="mw-headline" id="Headline_2">Headline 2</span></h2>
 <p>More
-</p>
-<h3><span class="editsection">[<a href="/index.php?title=Parser_test&amp;action=edit&amp;section=3" title="Edit section: Smaller headline">edit</a>]</span> <span class="mw-headline" id="Smaller_headline">Smaller headline</span></h3>
+</p><h3><span class="editsection">[<a href="/index.php?title=Parser_test&amp;action=edit&amp;section=3" title="Edit section: Smaller headline">edit</a>]</span> <span class="mw-headline" id="Smaller_headline">Smaller headline</span></h3>
 <p>Blah blah
 </p>
 !! end
@@ -4081,8 +4073,7 @@
 <h6><span class="editsection">[<a href="/index.php?title=Parser_test&amp;action=edit&amp;section=4" title="Edit section: Skipping a level">edit</a>]</span> <span class="mw-headline" id="Skipping_a_level_2"> Skipping a level </span></h6>
 <h2><span class="editsection">[<a href="/index.php?title=Parser_test&amp;action=edit&amp;section=5" title="Edit section: Headline 2">edit</a>]</span> <span class="mw-headline" id="Headline_2"> Headline 2 </span></h2>
 <p>Some text
-</p>
-<h3><span class="editsection">[<a href="/index.php?title=Parser_test&amp;action=edit&amp;section=6" title="Edit section: Another headline">edit</a>]</span> <span class="mw-headline" id="Another_headline">Another headline</span></h3>
+</p><h3><span class="editsection">[<a href="/index.php?title=Parser_test&amp;action=edit&amp;section=6" title="Edit section: Another headline">edit</a>]</span> <span class="mw-headline" id="Another_headline">Another headline</span></h3>
 
 !! end
 
@@ -4583,8 +4574,8 @@
 !! input
 [[Media:Foobar.jpg|Safe Link<div style=display:none>" onmouseover="alert(document.cookie)" onfoo="</div>]]
 !! result
-<a href="http://example.com/images/3/3a/Foobar.jpg" class="internal" title="Foobar.jpg">Safe Link&lt;div style="display:none"&gt;" onmouseover="alert(document.cookie)" onfoo="&lt;/div&gt;</a>
-
+<div class="paragraph"><a href="http://example.com/images/3/3a/Foobar.jpg" class="internal" title="Foobar.jpg">Safe Link&lt;div style="display:none"&gt;" onmouseover="alert(document.cookie)" onfoo="&lt;/div&gt;</a>
+</div>
 !! end
 
 !! test
@@ -5122,8 +5113,8 @@
 string(5) "<tag>"
 array(0) {
 }
-</pre>&lt;/tag&gt;
-
+</pre><p>&lt;/tag&gt;
+</p>
 !! end
 
 !! test
@@ -5173,8 +5164,8 @@
   ["foo"]=>
   string(3) "bar"
 }
-</pre>text
-
+</pre><p>text
+</p>
 !! end
 
 # </tag> should be output literally since there is no matching tag that begins it
@@ -5224,8 +5215,7 @@
 <!-- <statictag>hello, world</statictag> -->
 <statictag action=flush/>
 !! result
-<p><br />
-</p>
+<p><br /></p>
 !! end
 
 # Nested template calls; this case was broken by Parser.php rev 1.506,
@@ -5261,7 +5251,7 @@
 !! input
 <s></s><table></table>
 !! result
-<s></s><table></table>
+<p><s></s></p><table></table>
 
 !! end
 
@@ -5607,7 +5597,7 @@
 http://__TOC__
 !! result
 <h2><span class="editsection">[<a href="/index.php?title=Parser_test&amp;action=edit&amp;section=1" title="Edit section: onmouseover=">edit</a>]</span> <span class="mw-headline" id="onmouseover.3D"> onmouseover= </span></h2>
-http://<table id="toc" class="toc"><tr><td><div id="toctitle"><h2>Contents</h2></div>
+<p>http://</p><table id="toc" class="toc"><tr><td><div id="toctitle"><h2>Contents</h2></div>
 <ul>
 <li class="toclevel-1 tocsection-1"><a href="#onmouseover.3D"><span class="tocnumber">1</span> <span class="toctext">onmouseover=</span></a></li>
 </ul>
@@ -5675,8 +5665,7 @@
 {|
 !!result
 <p><a rel="nofollow" class="external free" href="http://===r:::https://b">http://===r:::https://b</a>
-</p>
-<table>
+</p><table>
 <tr><td></td></tr>
 </table>
 
@@ -5698,12 +5687,11 @@
 |
 !! result
 <table>
-{{{|
+<p>{{{|
 <u class="&#124;">}}}} &gt;
 <br style="onmouseover=&#39;alert(document.cookie);&#39;" />
-
-MOVE YOUR MOUSE CURSOR OVER THIS TEXT
-<tr>
+</p><p>MOVE YOUR MOUSE CURSOR OVER THIS TEXT
+</p><tr>
 <td></u>
 </td>
 </tr>
@@ -5758,7 +5746,7 @@
 !! input
 http://example.com<pre>junk</pre>
 !! result
-<a rel="nofollow" class="external free" href="http://example.com">http://example.com</a><pre>junk</pre>
+<p><a rel="nofollow" class="external free" href="http://example.com">http://example.com</a></p><pre>junk</pre>
 
 !!end
 
@@ -5889,8 +5877,6 @@
 !! input
 {{Special:Prefixindex/Xyzzyx}}
 !! result
-<p><br />
-</p>
 <table border="0" id="mw-prefixindex-list-table"><tr><td><a href="/wiki/Xyzzyx" title="Xyzzyx">Xyzzyx</a></td></tr></table>
 
 !! end
@@ -5902,11 +5888,7 @@
 {{Special:Prefixindex/Xyzzyx}}
 {{Special:Prefixindex/Xyzzyx}}
 !! result
-<p><br />
-</p>
 <table border="0" id="mw-prefixindex-list-table"><tr><td><a href="/wiki/Xyzzyx" title="Xyzzyx">Xyzzyx</a></td></tr></table>
-<p><br />
-</p>
 <table border="0" id="mw-prefixindex-list-table"><tr><td><a href="/wiki/Xyzzyx" title="Xyzzyx">Xyzzyx</a></td></tr></table>
 
 !! end
@@ -6837,13 +6819,9 @@
 </li><li> Talk:Parser_test
 </li><li> Parser test
 </li><li> Parser_test
-</li><li> 
-</li><li> 
+</li><li></li><li></li><li> Talk
 </li><li> Talk
-</li><li> Talk
-</li><li> 
-</li><li> 
-</li><li> <a href="/index.php?title=Template:Dynamic&amp;action=edit&amp;redlink=1" class="new" title="Template:Dynamic (page does not exist)">Template:Dynamic</a>
+</li><li></li><li></li><li> <a href="/index.php?title=Template:Dynamic&amp;action=edit&amp;redlink=1" class="new" title="Template:Dynamic (page does not exist)">Template:Dynamic</a>
 </li></ul>
 
 !! end
@@ -6873,8 +6851,7 @@
 			<div style="height: 150px;">Image2.gif</div>
 			<div class="gallerytext">
 <p>||||
-</p>
-			</div>
+			</p></div>
 		</div></li>
 		<li class="gallerybox" style="width: 155px"><div style="width: 155px">
 			<div style="height: 150px;">Image3</div>
@@ -6885,15 +6862,13 @@
 			<div style="height: 150px;">Image4</div>
 			<div class="gallerytext">
 <p>300px| centre
-</p>
-			</div>
+			</p></div>
 		</div></li>
 		<li class="gallerybox" style="width: 155px"><div style="width: 155px">
 			<div style="height: 150px;">Image5.svg</div>
 			<div class="gallerytext">
 <p><a rel="nofollow" class="external free" href="http://///////">http://///////</a>
-</p>
-			</div>
+			</p></div>
 		</div></li>
 		<li class="gallerybox" style="width: 155px"><div style="width: 155px">
 			<div style="height: 150px;">* image6</div>
@@ -7092,8 +7067,7 @@
 __NEWSECTIONLINK__
 __FORCETOC__
 !! result
-<p><br />
-</p>
+<p><br /></p>
 !! end
 
 !! test
@@ -7269,8 +7243,8 @@
 !! input
 <html><script>alert(1);</script></html>
 !! result
-<p><script>alert(1);</script>
-</p>
+<div class="paragraph"><script>alert(1);</script>
+</div>
 !! end
 
 !! test
@@ -7592,11 +7566,9 @@
 !! result
 <center>
 <p>foo
-</p>
-</center>
+</p></center>
 <p>bar
-</p>
-<pre>baz
+</p><pre>baz
 </pre>
 !! end
 
@@ -7908,8 +7880,7 @@
 y
 !! result
 <p>x
-</p>
-<table>
+</p><table>
 <tr>
 <td> 1 </td>
 <td> 2
@@ -7984,8 +7955,7 @@
 ==heading==
 !! result
 <p>[[link
-</p>
-<h2><span class="editsection">[<a href="/index.php?title=Parser_test&amp;action=edit&amp;section=1" title="Edit section: heading">edit</a>]</span> <span class="mw-headline" id="heading">heading</span></h2>
+</p><h2><span class="editsection">[<a href="/index.php?title=Parser_test&amp;action=edit&amp;section=1" title="Edit section: heading">edit</a>]</span> <span class="mw-headline" id="heading">heading</span></h2>
 
 !! end
 
@@ -7996,8 +7966,7 @@
 =heading=
 !! result
 <p>{{foo|
-</p>
-<h1> <span class="mw-headline" id="heading">heading</span></h1>
+</p><h1> <span class="mw-headline" id="heading">heading</span></h1>
 
 !! end
 
@@ -8008,8 +7977,7 @@
 ==heading==
 !! result
 <p>{{foo|
-</p>
-<h2><span class="editsection">[<a href="/index.php?title=Parser_test&amp;action=edit&amp;section=1" title="Edit section: heading">edit</a>]</span> <span class="mw-headline" id="heading">heading</span></h2>
+</p><h2><span class="editsection">[<a href="/index.php?title=Parser_test&amp;action=edit&amp;section=1" title="Edit section: heading">edit</a>]</span> <span class="mw-headline" id="heading">heading</span></h2>
 
 !! end
 
@@ -8031,7 +7999,7 @@
 Line two</div>
 !! result
 <div>Line one
-Line two</div>
+<p>Line two</p></div>
 
 !! end
 
@@ -8045,8 +8013,7 @@
 !! result
 <div>
 <p>Line one
-</p>
-Line two</div>
+</p><p>Line two</p></div>
 
 !! end
 
@@ -8060,8 +8027,7 @@
 !! result
 <div>Line one
 <p>Line two
-</p>
-</div>
+</p></div>
 
 !! end
 
@@ -8077,8 +8043,7 @@
 <div>
 <p>Line one
 </p><p>Line two
-</p>
-</div>
+</p></div>
 
 !! end
 
@@ -8099,22 +8064,18 @@
 # Bug 6200: <blockquote> should behave like <div> with respect to line breaks
 !! test
 Bug 6200: paragraphs inside blockquotes (no extra line breaks)
-!! options
-disabled
 !! input
 <blockquote>Line one
 
 Line two</blockquote>
 !! result
 <blockquote>Line one
-Line two</blockquote>
+<p>Line two</p></blockquote>
 
 !! end
 
 !! test
 Bug 6200: paragraphs inside blockquotes (extra line break on open)
-!! options
-disabled
 !! input
 <blockquote>
 Line one
@@ -8123,15 +8084,12 @@
 !! result
 <blockquote>
 <p>Line one
-</p>
-Line two</blockquote>
+</p><p>Line two</p></blockquote>
 
 !! end
 
 !! test
 Bug 6200: paragraphs inside blockquotes (extra line break on close)
-!! options
-disabled
 !! input
 <blockquote>Line one
 
@@ -8140,15 +8098,12 @@
 !! result
 <blockquote>Line one
 <p>Line two
-</p>
-</blockquote>
+</p></blockquote>
 
 !! end
 
 !! test
 Bug 6200: paragraphs inside blockquotes (extra line break on open and close)
-!! options
-disabled
 !! input
 <blockquote>
 Line one
@@ -8159,8 +8114,7 @@
 <blockquote>
 <p>Line one
 </p><p>Line two
-</p>
-</blockquote>
+</p></blockquote>
 
 !! end
 
@@ -8172,7 +8126,7 @@
 Line two</div></blockquote>
 !! result
 <blockquote><div>Line one
-Line two</div></blockquote>
+<p>Line two</p></div></blockquote>
 
 !! end
 
@@ -8186,8 +8140,7 @@
 !! result
 <blockquote><div>
 <p>Line one
-</p>
-Line two</div></blockquote>
+</p><p>Line two</p></div></blockquote>
 
 !! end
 
@@ -8201,8 +8154,7 @@
 !! result
 <blockquote><div>Line one
 <p>Line two
-</p>
-</div></blockquote>
+</p></div></blockquote>
 
 !! end
 
@@ -8218,8 +8170,7 @@
 <blockquote><div>
 <p>Line one
 </p><p>Line two
-</p>
-</div></blockquote>
+</p></div></blockquote>
 
 !! end
 
