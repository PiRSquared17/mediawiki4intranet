# HG changeset patch
# User Vitaliy Filippov <vitali@st-filippov.office.custis.ru>
# Date 1282044113 -14400
Make file extensions lower-case in upload form autofill JS
Bug 68017 - Configurable maximum filename length in image galleries

diff -r 6b77a2bb86d2 -r 764a5c46f92b includes/DefaultSettings.php
--- includes/DefaultSettings.php
+++ includes/DefaultSettings.php
@@ -429,6 +429,8 @@
  * normal uploads is currently to edit php.ini.
  */
 $wgMaxUploadSize = 1024*1024*100; # 100MB
+/** Maximum length for filenames shown in image gallery. */
+$wgMaxFilenameLength = 20;
 
 /**
  * Point the upload navigation link to an external URL
diff -r 6b77a2bb86d2 -r 764a5c46f92b includes/ImageGallery.php
--- includes/ImageGallery.php
+++ includes/ImageGallery.php
@@ -218,7 +218,7 @@
 	 *
 	 */
 	function toHTML() {
-		global $wgLang;
+		global $wgLang, $wgMaxFilenameLength;
 
 		$sk = $this->getSkin();
 
@@ -289,7 +289,7 @@
 			}
 
 			$textlink = $this->mShowFilename ?
-				$sk->makeKnownLinkObj( $nt, htmlspecialchars( $wgLang->truncate( $nt->getText(), 20, '...' ) ) ) . "<br />\n" :
+				$sk->makeKnownLinkObj( $nt, htmlspecialchars( $wgLang->truncate( $nt->getText(), $wgMaxFilenameLength, '...' ) ) ) . "<br />\n" :
 				'' ;
 
 			# ATTENTION: The newline after <div class="gallerytext"> is needed to accommodate htmltidy which
diff -r 6b77a2bb86d2 -r 764a5c46f92b skins/common/upload.js
--- skins/common/upload.js
+++ skins/common/upload.js
@@ -131,6 +131,11 @@
 		fname = path.substring(backslash+1, 10000);
 	}
 
+	// Find and make extension lower-case
+	var dot = fname.lastIndexOf('.');
+	if (dot >= 0)
+		fname = fname.substring(0,dot).concat(fname.substring(dot, fname.length).toLowerCase());
+
 	// Capitalise first letter and replace spaces by underscores
 	fname = fname.charAt(0).toUpperCase().concat(fname.substring(1,10000)).replace(/ /g, '_');
 
