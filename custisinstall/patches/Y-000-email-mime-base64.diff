# HG changeset patch
# User Vitaliy Filippov <vitalif@yourcmc.ru>
# Date 1301661980 -14400
Bug 78064 - Use MIME-Base64 encoding for mail headers instead of MIME-QuotedPrintable

diff -r 9cc4b1960d33 -r eda1ac3e9931 includes/GlobalFunctions.php
--- includes/GlobalFunctions.php
+++ includes/GlobalFunctions.php
@@ -1273,6 +1273,27 @@
 	return $out;
 }
 
+// Uses iconv php extension, calls wfQuotedPrintable if it's unavailable
+function wfMimeBase64( $string, $charset = '' )
+{
+	if( empty( $charset ) )
+	{
+		global $wgInputEncoding;
+		$charset = $wgInputEncoding;
+	}
+	if ( !function_exists( 'iconv_mime_encode' ) )
+	{
+		// Do not split and recode the string when iconv is unavailable
+		return '=?'.$charset.'?B?'.base64_encode( $string ).'?=';
+	}
+	return substr( iconv_mime_encode( '', $string, array(
+		'input-charset' => $charset,
+		'output-charset' => 'utf-8',
+		'line-length' => 76,
+		'line-break-chars' => "\n",
+		'scheme' => 'B'
+	) ), 2 );
+}
 
 /**
  * @todo document
diff -r 9cc4b1960d33 -r eda1ac3e9931 includes/UserMailer.php
--- includes/UserMailer.php
+++ includes/UserMailer.php
@@ -141,7 +141,7 @@
 			if ( $replyto ) {
 				$headers['Reply-To'] = $replyto->toString();
 			}
-			$headers['Subject'] = wfQuotedPrintable( $subject );
+			$headers['Subject'] = wfMimeBase64( $subject );
 			$headers['Date'] = date( 'r' );
 			$headers['MIME-Version'] = '1.0';
 			$headers['Content-type'] = (is_null($contentType) ?
