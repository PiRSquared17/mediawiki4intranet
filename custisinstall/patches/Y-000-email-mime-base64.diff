# HG changeset patch
# User Vitaliy Filippov <vitalif@yourcmc.ru>
# Date 1327949018 -14400
Bug 78064 - Use MIME-Base64 encoding for mail headers instead of MIME-QuotedPrintable

diff -r 6b6371ec1416 -r fcf433d92b28 includes/UserMailer.php
--- includes/UserMailer.php
+++ includes/UserMailer.php
@@ -59,7 +59,7 @@
 			if ( $this->name != '' && !wfIsWindows() ) {
 				global $wgEnotifUseRealName;
 				$name = ( $wgEnotifUseRealName && $this->realName ) ? $this->realName : $this->name;
-				$quoted = UserMailer::quotedPrintable( $name );
+				$quoted = UserMailer::mimeBase64( $name );
 				if ( strpos( $quoted, '.' ) !== false || strpos( $quoted, ',' ) !== false ) {
 					$quoted = '"' . $quoted . '"';
 				}
@@ -165,7 +165,7 @@
 			if ( $replyto ) {
 				$headers['Reply-To'] = $replyto->toString();
 			}
-			$headers['Subject'] = self::quotedPrintable( $subject );
+			$headers['Subject'] = self::mimeBase64( $subject );
 			$headers['Date'] = date( 'r' );
 			$headers['MIME-Version'] = '1.0';
 			$headers['Content-type'] = ( is_null( $contentType ) ?
@@ -230,7 +230,7 @@
 				$to = array( $to );
 			}
 			foreach ( $to as $recip ) {
-				$sent = mail( $recip->toString(), self::quotedPrintable( $subject ), $body, $headers, $wgAdditionalMailParams );
+				$sent = mail( $recip->toString(), self::mimeBase64( $subject ), $body, $headers, $wgAdditionalMailParams );
 			}
 
 			restore_error_handler();
@@ -270,6 +270,26 @@
 	}
 
 	/**
+	 * Converts a string into MIME-Base64 header encoding.
+	 */
+	public static function mimeBase64( $string, $charset = '' ) {
+		if( empty( $charset ) ) {
+			$charset = 'UTF-8';
+		}
+		if ( !function_exists( 'iconv_mime_encode' ) ) {
+			// Do not split and recode the string when iconv is unavailable
+			return '=?'.$charset.'?B?'.base64_encode( $string ).'?=';
+		}
+		return substr( iconv_mime_encode( '', $string, array(
+			'input-charset' => $charset,
+			'output-charset' => 'utf-8',
+			'line-length' => 76,
+			'line-break-chars' => "\n",
+			'scheme' => 'B'
+		) ), 2 );
+	}
+
+	/**
 	 * Converts a string into quoted-printable format
 	 * @since 1.17
 	 */
