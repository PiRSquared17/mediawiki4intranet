# HG changeset patch
# User Vitaliy Filippov <vitali@st-filippov.office.custis.ru>
# Date 1297036273 -10800
Bug 57350 - No wgPdfProcessor escape, add #page= into pdf links

diff -r b11befdd7427 -r 6089afc26d21 extensions/PdfHandler/PdfHandler_body.php
--- extensions/PdfHandler/PdfHandler_body.php
+++ extensions/PdfHandler/PdfHandler_body.php
@@ -21,6 +21,16 @@
  * http://www.gnu.org/copyleft/gpl.html
  */
 
+class PdfThumbnailImage extends ThumbnailImage
+{
+	function toHtml( $options = array() )
+	{
+		if ( $options['file-link'] )
+			$options['custom-url-link'] = $this->file->getURL() . '#page=' . $this->page;
+		return parent::toHtml( $options );
+	}
+}
+
 class PdfHandler extends ImageHandler {
 
 	function isEnabled() {
@@ -111,7 +121,7 @@
 		}
 
 		if ( $flags & self::TRANSFORM_LATER ) {
-			return new ThumbnailImage( $image, $dstUrl, $width,
+			return new PdfThumbnailImage( $image, $dstUrl, $width,
 							$height, $dstPath, $page );
 		}
 
@@ -119,7 +129,7 @@
 			return $this->doThumbError( $width, $height, 'thumbnail_dest_directory' );
 		}
 
-		$cmd = '(' . wfEscapeShellArg( $wgPdfProcessor );
+		$cmd = '(' . $wgPdfProcessor;
 		$cmd .= " -sDEVICE=jpeg -sOutputFile=- -dFirstPage={$page} -dLastPage={$page}";
 		$cmd .= " -r{$wgPdfHandlerDpi} -dBATCH -dNOPAUSE -q ". wfEscapeShellArg( $srcPath );
 		$cmd .= " | " . wfEscapeShellArg( $wgPdfPostProcessor );
@@ -141,7 +151,7 @@
 				wfHostname(), $retval, trim( $err ), $cmd ) );
 			return new MediaTransformError( 'thumbnail_error', $width, $height, $err );
 		} else {
-			return new ThumbnailImage( $image, $dstUrl, $width, $height, $dstPath, $page );
+			return new PdfThumbnailImage( $image, $dstUrl, $width, $height, $dstPath, $page );
 		}
 	}
 
