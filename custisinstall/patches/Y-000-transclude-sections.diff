# HG changeset patch
# User Vitaliy Filippov <vitali@st-filippov.office.custis.ru>
# Date 1287161536 -14400
Bug 70192 - named section transclusion

diff -r 2951a613ce57 -r a72839f5e483 includes/parser/Parser.php
--- includes/parser/Parser.php
+++ includes/parser/Parser.php
@@ -3069,6 +3069,10 @@
 		$cacheTitle = $title;
 		$titleText = $title->getPrefixedDBkey();
 
+		// CustIS Bug 70192 - named section transclusion
+		if ( $frag = $title->getFragment() )
+			$titleText .= '#' . $frag;
+
 		if ( isset( $this->mTplRedirCache[$titleText] ) ) {
 			list( $ns, $dbk ) = $this->mTplRedirCache[$titleText];
 			$title = Title::makeTitle( $ns, $dbk );
@@ -3087,6 +3091,9 @@
 		}
 
 		$dom = $this->preprocessToDom( $text, self::PTD_FOR_INCLUSION );
+		// CustIS Bug 70192 - named section transclusion
+		if ( $frag )
+			$dom = $this->tryExtractNamedSection( $dom, $frag );
 		$this->mTplDomCache[ $titleText ] = $dom;
 
 		if (! $title->equals($cacheTitle)) {
@@ -3098,6 +3105,72 @@
 	}
 
 	/**
+	 * CustIS Bug 70192 - try to extract a named section from DOM Document
+	 */
+	function tryExtractNamedSection( $dom, $frag )
+	{
+		$stack = array( array( $dom->node, 0 ) );
+		$foundlevel = false;
+		$newroot = NULL;
+		while( $stack )
+		{
+			$ptr = &$stack[ count( $stack ) - 1 ];
+			if ( $ptr[1] >= $ptr[0]->childNodes->length )
+			{
+				array_pop( $stack );
+				if ( $foundlevel )
+					$newroot = $newroot->parentNode;
+				continue;
+			}
+			$node = $ptr[0]->childNodes->item( $ptr[1] );
+			$ptr[1]++;
+			if ( !$foundlevel )
+			{
+				if ( $node->nodeName == 'h' )
+				{
+					$h = $node->nodeValue;
+					$l = $node->getAttribute( 'level' );
+					$h = trim( substr( $h, $l, -$l ) );
+					if ( $h == $frag )
+					{
+						$foundlevel = $l;
+						foreach ( $stack as $inside )
+						{
+							$el = $inside[0]->cloneNode();
+							if ( $newroot )
+								$newroot->addChild( $el );
+							$newroot = $el;
+						}
+					}
+				}
+				elseif ( $node->childNodes->length )
+					$stack[] = array( $node, 0 );
+			}
+			else
+			{
+				if ( $node->nodeName == 'h' && $node->getAttribute( 'level' ) <= $foundlevel )
+					break;
+				if ( !$content_started && $node->nodeType == XML_TEXT_NODE )
+				{
+					// left-trim included section
+					$v = ltrim( $node->nodeValue );
+					if ( !$v )
+						continue;
+					else
+						$newroot->appendChild( $newroot->ownerDocument->createTextNode( $v ) );
+				}
+				else
+					$newroot->appendChild( $node->cloneNode( true ) );
+				$content_started = true;
+			}
+		}
+		unset( $ptr );
+		if ( $newroot )
+			$dom = new PPNode_DOM( $newroot );
+		return $dom;
+	}
+
+	/**
 	 * Fetch the unparsed text of a template and register a reference to it.
 	 */
 	function fetchTemplateAndTitle( $title ) {
