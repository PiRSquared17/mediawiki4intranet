# HG changeset patch
# User Vitaliy Filippov <vitali@st-filippov.office.custis.ru>
# Date 1268239221 -10800
Wikilog extension debug:
Bug 58154 - fix caching error
Bug 56056 - do not handle post subarticles as posts themselves
Bug 61175 - default sort direction

diff -r 2f012c39365a -r 2e50fe2fca48 extensions/Wikilog/Wikilog.php
--- extensions/Wikilog/Wikilog.php
+++ extensions/Wikilog/Wikilog.php
@@ -423,16 +423,13 @@
 		$ns = MWNamespace::getSubject( $origns );
 		$tns = MWNamespace::getTalk( $origns );
 
-		if ( strpos( $title->getText(), '/' ) !== false ) {
-			# If title contains a '/', treat as a wikilog article title.
-			list( $this->mWikilogName, $this->mItemName ) =
-				explode( '/', $title->getText(), 2 );
-
-			if ( strpos( $this->mItemName, '/' ) !== false ) {
-				list( $this->mItemName, $this->mTrailing ) =
-					explode( '/', $this->mItemName, 2 );
-			}
-
+		# If title contains a '/', treat as a wikilog article title.
+		$parts = explode('/', $title->getText());
+		if (count($parts) > 1 && ($this->mIsTalk || count($parts) == 2))
+		{
+			$this->mWikilogName = array_shift($parts);
+			$this->mItemName = array_shift($parts);
+			$this->mTrailing = implode('/', $parts);
 			$rawtitle = "{$this->mWikilogName}/{$this->mItemName}";
 			$this->mWikilogTitle = Title::makeTitle( $ns, $this->mWikilogName );
 			$this->mItemTitle = Title::makeTitle( $ns, $rawtitle );
diff -r 2f012c39365a -r 2e50fe2fca48 extensions/Wikilog/WikilogComment.php
--- extensions/Wikilog/WikilogComment.php
+++ extensions/Wikilog/WikilogComment.php
@@ -740,7 +740,7 @@
 			}
 		}
 		if ( $extra ) {
-			$extra = wfMsgForContent( 'parentheses', $wgContLang->pipeList( $extra ) );
+			$extra = implode( ' | ', $extra );
 		} else {
 			$extra = "";
 		}
diff -r 2f012c39365a -r 2e50fe2fca48 extensions/Wikilog/WikilogFeed.php
--- extensions/Wikilog/WikilogFeed.php
+++ extensions/Wikilog/WikilogFeed.php
@@ -361,7 +361,6 @@
 		if ( !$limit ) $limit = $wgWikilogNumArticles;
 		parent::__construct( $title, $format, $query, $limit );
 		$this->mSiteFeed = $this->mQuery->getWikilogTitle() === null;
-		
 	}
 
 	public function getIndexField() {
@@ -507,7 +506,7 @@
 		# Create new syndication entry.
 		$entry = new WlSyndicationEntry(
 			self::makeEntryId( $itemTitle ),
-			$itemName,
+			( $this->mSiteFeed ? $wikilogName . ' â€” ' : '' ) . $itemName,
 			$row->wlp_updated,
 			$itemTitle->getFullUrl()
 		);
diff -r 2f012c39365a -r 2e50fe2fca48 extensions/Wikilog/WikilogHooks.php
--- extensions/Wikilog/WikilogHooks.php
+++ extensions/Wikilog/WikilogHooks.php
@@ -57,7 +57,7 @@
 		if ( $title->isTalkPage() ) {
 			# ::WikilogCommentsPage::
 			# Invalidate cache of wikilog item page.
-			if ( $wi->getItemTitle()->exists() ) {
+			if ( $wi->getItemTitle() && $wi->getItemTitle()->exists() ) {
 				$wi->getItemTitle()->invalidateCache();
 				$wi->getItemTitle()->purgeSquid();
 			}
diff -r 2f012c39365a -r 2e50fe2fca48 extensions/Wikilog/WikilogItemPager.php
--- extensions/Wikilog/WikilogItemPager.php
+++ extensions/Wikilog/WikilogItemPager.php
@@ -498,6 +498,10 @@
 	}
 
 	function getDefaultSort() {
+		global $wgRequest;
+		// A hack to set default sort direction
+		if ( !$wgRequest->getBool( 'asc' ) && ! $wgRequest->getBool( 'desc' ))
+			$wgRequest->setVal('desc', 1);
 		return 'wlp_pubdate';
 	}
 
diff -r 2f012c39365a -r 2e50fe2fca48 extensions/Wikilog/WikilogUtils.php
--- extensions/Wikilog/WikilogUtils.php
+++ extensions/Wikilog/WikilogUtils.php
@@ -89,7 +89,7 @@
 				: ParserCache::singleton();
 
 			# Look for the parsed article output in the parser cache.
-			$parserOutput = $parserCache->get( $article, $parserOpt );
+			$parserOutput = $parserCache->get( $article, $wgUser );
 
 			# On success, return the object retrieved from the cache.
 			if ( $parserOutput ) {
@@ -123,7 +123,7 @@
 
 		# Save in parser cache.
 		if ( $useParserCache && $parserOutput->getCacheTime() != -1 ) {
-			$parserCache->save( $parserOutput, $article, $parserOpt );
+			$parserCache->save( $parserOutput, $article, $wgUser );
 		}
 
 		# Restore default behavior.
