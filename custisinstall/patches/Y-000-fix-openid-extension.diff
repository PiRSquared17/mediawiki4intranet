# HG changeset patch
# User Vitaliy Filippov <vitalif@yourcmc.ru>
# Date 1329403619 -14400
Bug 67208 - Always send redirect instead of POST when URL is <= 2048 bytes; Bug 85659 - OpenID prompt on login

diff -r 2b1195378d97 -r 713fc30c0da5 extensions/OpenID/OpenID.i18n.php
--- extensions/OpenID/OpenID.i18n.php
+++ extensions/OpenID/OpenID.i18n.php
@@ -34,6 +34,7 @@
 $messages['en'] = array(
 	'openid-desc' => 'Let users log in to the wiki with an [http://openid.net/ OpenID]. If this is enabled on the wiki, they can also use their user account URL of this wiki as OpenID to log in to other OpenID-aware web sites',
 	'openidlogin' => 'Log in / create account with OpenID',
+	'nologin' => "{{SERVER}}{{SCRIPTPATH}}/extensions/OpenID/skin/icons/openid-inputicon.png [[Special:OpenIDLogin|Log in with OpenID]].\n\nDon't have an account? $1.",
 	'openidserver' => 'OpenID server',
 	'openidxrds' => 'Yadis file',
 	'openidconvert' => 'OpenID converter',
@@ -4915,6 +4916,7 @@
 $messages['ru'] = array(
 	'openid-desc' => 'Вход в вики с помощью [http://openid.net/ OpenID], а также вход на другие сайты поддерживающие OpenID с помощью учётной записи в вики',
 	'openidlogin' => 'Вход с помощью OpenID',
+	'nologin' => "{{SERVER}}{{SCRIPTPATH}}/extensions/OpenID/skin/icons/openid-inputicon.png [[Special:OpenIDLogin|Вход с помощью OpenID]].\n\nНет учётной записи? '''$1'''.",
 	'openidserver' => 'Сервер OpenID',
 	'openidxrds' => 'Файл Yadis',
 	'openidconvert' => 'Преобразователь OpenID',
@@ -4961,7 +4963,8 @@
 	'openidconvertsuccesstext' => 'Вы успешно преобразовали ваш OpenID в $1.',
 	'openidconvertyourstext' => 'Это уже ваш OpenID.',
 	'openidconvertothertext' => 'Это чужой OpenID.',
-	'openidalreadyloggedin' => "'''Вы уже вошли, $1!'''
+	'openidalreadyloggedin' => 'Вы уже вошли!',
+	'openidalreadyloggedintext' => "'''Вы уже вошли, $1!'''
 
 Если вы желаете использовать в будущем вход через OpenID, вы можете [[Special:OpenIDConvert|преобразовать вашу учётную запись для использования в OpenID]].",
 	'openidnousername' => 'Не указано имя участника.',
diff -r 2b1195378d97 -r 713fc30c0da5 extensions/OpenID/SpecialOpenID.body.php
--- extensions/OpenID/SpecialOpenID.body.php
+++ extensions/OpenID/SpecialOpenID.body.php
@@ -269,9 +269,9 @@
 
 		$process_url = $this->scriptUrl( $finish_page );
 
-		if ( $auth_request->shouldSendRedirect() ) {
-			$redirect_url = $auth_request->redirectURL( $trust_root,
-													   $process_url );
+		$redirect_url = $auth_request->redirectURL( $trust_root,
+												   $process_url );
+		if ( strlen( $redirect_url ) <= 2048 ) {
 			if ( Auth_OpenID::isFailure( $redirect_url ) ) {
 				displayError( "Could not redirect to server: " . $redirect_url->message );
 			} else {
diff -r 2b1195378d97 -r 713fc30c0da5 extensions/OpenID/SpecialOpenIDLogin.body.php
--- extensions/OpenID/SpecialOpenIDLogin.body.php
+++ extensions/OpenID/SpecialOpenIDLogin.body.php
@@ -500,6 +500,10 @@
 	function updateUser( $user, $sreg, $ax, $force = false ) {
 		global $wgAllowRealName, $wgEmailAuthentication, $wgOpenIDTrustEmailAddress;
 
+		if ( !$ax ) {
+			$ax = array();
+		}
+
 		// Nick name
 		if ( $this->updateOption( 'nickname', $user, $force ) ) {
 			if ( array_key_exists( 'nickname', $sreg ) && $sreg['nickname'] != $user->getOption( 'nickname' ) ) {
